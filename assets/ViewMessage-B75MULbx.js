import{W as L,b as D,l as H,r as b,s as h,a as i,j as e,H as E,L as F,B as _,U as K,d as k}from"./main-BHPIGV8h.js";import{T as W}from"./textarea-DDVBgeYU.js";import{u as Y,F as X,a as G,b as J,d as Q,e as A,t as Z,o as ee,s as se}from"./form-Bb0e-UzI.js";import{a as S}from"./supabaseHelpers-CPJLcMFB.js";import{A as re,a as te,b as ae}from"./avatar-M7QsreIS.js";import{B as ne}from"./BackgroundWrapper-C6a75pID.js";import{B as oe,C as ie}from"./badge-Bop49VJa.js";import{E as le,S as de,C as ce}from"./EmojiPickerPopover-CWEmy9fA.js";import{A as T}from"./arrow-left-C4HDbgt0.js";import{S as me}from"./send-ChfChDUX.js";import"./index-CIk3TtyT.js";const ue=ee({replyContent:se().min(1,{message:"Reply cannot be empty."}).max(1e3,{message:"Reply is too long."})}),B=(o,y,r=!1)=>{const f=o.sender_id===(y==null?void 0:y.id),s=K(o.created_at);return e.jsx("div",{className:k("flex w-full",f?"justify-end":"justify-start"),children:e.jsxs("div",{className:k("max-w-[70%] p-4 rounded-xl shadow-md",f?"bg-primary text-primary-foreground rounded-br-none":"bg-secondary text-secondary-foreground dark:bg-muted-foreground/20 rounded-bl-none",r?"mt-2":""),children:[e.jsx("p",{className:k("whitespace-pre-wrap text-base text-left",f?"text-primary-foreground":"text-secondary-foreground dark:text-foreground"),children:o.content}),e.jsxs("div",{className:k("text-xs mt-2",f?"text-primary-foreground/80 text-right":"text-secondary-foreground/80 dark:text-muted-foreground text-left"),children:[s,o.read_at&&f&&e.jsxs("span",{className:"ml-2 flex items-center justify-end gap-1",children:[e.jsx(ie,{className:"w-3 h-3"})," Read"]})]})]})},o.id)},ke=()=>{var R;const{id:o}=L(),y=D(),{user:r,loading:f}=H(),[s,x]=b.useState(null),[I,j]=b.useState(!0),[P,V]=b.useState(!1),m=Y({resolver:Z(ue),defaultValues:{replyContent:""}}),C=b.useRef(null),O=async()=>{if(f||!r||!o){j(!1);return}j(!0);try{const{data:a,error:t}=await h.from("messages").select("*").eq("id",o).single();if(t){i.error("Failed to load message: "+t.message),x(null),j(!1);return}if(!a){x(null),i.error("Message not found."),j(!1);return}const{data:l,error:n}=await h.from("messages").select("*").eq("parent_message_id",o).order("created_at",{ascending:!0});n&&i.error("Failed to load replies: "+n.message);const u=new Set;u.add(a.sender_id),u.add(a.receiver_id),l==null||l.forEach(c=>{u.add(c.sender_id),u.add(c.receiver_id)});const d=new Map;for(const c of Array.from(u)){const w=await S(c);w&&d.set(c,w)}const p=(l==null?void 0:l.map(c=>({...c,senderProfile:d.get(c.sender_id)||null,receiverProfile:d.get(c.receiver_id)||null})))||[],v={...a,senderProfile:d.get(a.sender_id)||null,receiverProfile:d.get(a.receiver_id)||null,replies:p};if(x(v),v.receiver_id===r.id&&!v.read_at){const{error:c}=await h.from("messages").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",o);c?console.error("Supabase Error marking message as read:",c.message):x(w=>w?{...w,is_read:!0,read_at:new Date().toISOString()}:null)}}catch{i.error("An unexpected error occurred while loading the message.")}finally{j(!1)}};b.useEffect(()=>{O();const a=h.channel(`message_view_${o}`).on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`id=eq.${o}.or.parent_message_id=eq.${o}`},async t=>{if(t.new,t.eventType==="UPDATE"&&t.old.id===o){const l=t.new;x(n=>n?{...n,...l}:null),l.status==="closed"&&i.info("This conversation has been closed by the sender.")}else if(t.eventType==="INSERT"&&t.new.parent_message_id===o){const l=t.new,n=await S(l.sender_id),u=await S(l.receiver_id);x(d=>{if(!d)return null;const p=[...d.replies||[],{...l,senderProfile:n,receiverProfile:u}];return{...d,replies:p}}),i.info(`New reply received from ${(n==null?void 0:n.username)||(n==null?void 0:n.email)||"Your Partner"}!`)}}).subscribe();return()=>{h.removeChannel(a)}},[o,r,f]),b.useEffect(()=>{C.current&&C.current.scrollIntoView({behavior:"smooth"})},[s]);const $=a=>{const t=m.getValues("replyContent");m.setValue("replyContent",t+a,{shouldValidate:!0})},M=async a=>{if(!r||!s){i.error("Cannot send reply: User or message not identified.");return}if(s.status==="closed"){i.error("Cannot reply to a closed message.");return}const t=s.sender_id===r.id?s.receiver_id:s.sender_id;if(!t){i.error("Cannot determine recipient for reply.");return}const l=r.user_metadata.nickname||r.email||"Unknown User";try{const{data:n,error:u}=await h.from("messages").insert({user_id:r.id,sender_id:r.id,receiver_id:t,author_name:l,subject:`Re: ${s.subject}`,content:a.replyContent,message_type:"Reply",priority:"Medium",mood:"Neutral",parent_message_id:s.id}).select().single();u?i.error(u.message):n&&(i.success("Reply sent successfully!"),m.reset(),x(d=>{if(!d)return null;const p=n.sender_id===r.id,v={...n,senderProfile:p?{id:r.id,username:r.user_metadata.nickname??null,email:r.email??null,avatar_url:r.user_metadata.avatar_url??null}:d.senderProfile,receiverProfile:p?d.receiverProfile:{id:r.id,username:r.user_metadata.nickname??null,email:r.email??null,avatar_url:r.user_metadata.avatar_url??null}},c=[...d.replies||[],v];return{...d,replies:c}}))}catch{i.error("An unexpected error occurred while sending the reply.")}},z=async()=>{if(!r||!s||s.sender_id!==r.id||s.status==="closed"){i.error("Cannot close message: Not your message, or already closed.");return}try{const{error:a}=await h.from("messages").update({status:"closed"}).eq("id",s.id);a?i.error(a.message):(i.success("Message closed successfully!"),x(t=>t?{...t,status:"closed"}:null))}catch{i.error("An unexpected error occurred while closing the message.")}};if(f||I)return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-background to-background/80 text-foreground",children:e.jsx("p",{className:"text-xl",children:"Loading message..."})});if(!r)return y("/login"),null;if(!s)return e.jsxs(e.Fragment,{children:[e.jsxs(E,{children:[e.jsx("title",{children:"Message Not Found - Anbae"}),e.jsx("meta",{name:"description",content:"The message you are looking for does not exist or you do not have permission to view it."})]}),e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-background to-background/80 p-4 text-center pt-20",children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground mb-4",children:"Message Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"The message you are looking for does not exist or you do not have permission to view it."}),e.jsx(F,{to:"/messages",children:e.jsxs(_,{variant:"outline",className:"text-foreground border-border hover:bg-accent hover:text-accent-foreground",children:[e.jsx(T,{className:"w-5 h-5 mr-2"})," Back to Messages"]})})]})]});const g=s.sender_id===r.id?s.receiverProfile:s.senderProfile,N=(g==null?void 0:g.username)||(g==null?void 0:g.email)||"Your Partner",U=s.sender_id===r.id&&s.status==="open",q=s.status==="open";return e.jsxs(e.Fragment,{children:[e.jsxs(E,{children:[e.jsx("title",{children:`Message with ${N} - Anbae`}),e.jsx("meta",{name:"description",content:`View your conversation with ${N} about ${s.subject}.`})]}),e.jsx(ne,{className:"pt-20",children:e.jsxs("div",{className:"w-full max-w-3xl mx-auto flex flex-col h-[calc(100vh-80px)]",children:[e.jsx("div",{className:"absolute top-4 left-4 z-10",children:e.jsx(F,{to:"/messages",children:e.jsx(_,{variant:"outline",size:"icon",className:"w-10 h-10 text-foreground border-border hover:bg-accent hover:text-accent-foreground rounded-full shadow-md",children:e.jsx(T,{className:"w-5 h-5"})})})}),e.jsxs("div",{className:"flex items-center justify-between mb-8 flex-shrink-0",children:[e.jsx("div",{className:"flex-grow"})," ",e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(re,{className:"w-16 h-16 border-2 border-primary dark:border-primary-foreground",children:[e.jsx(te,{src:(g==null?void 0:g.avatar_url)||"",alt:"Partner Avatar"}),e.jsx(ae,{className:"bg-primary text-primary-foreground",children:N.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("h1",{className:"text-4xl font-bold text-foreground",children:N}),e.jsxs("p",{className:"text-xl text-muted-foreground mt-1 flex items-center justify-end gap-2",children:[s.message_type,s.status==="closed"&&e.jsx(oe,{variant:"secondary",className:"ml-2 bg-muted text-muted-foreground",children:"Closed"})]})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 flex flex-col gap-y-4 pb-28",children:[s&&B(s,r),s&&s.replies&&s.replies.length>0&&e.jsx("div",{className:"space-y-4",children:s.replies.map(a=>B(a,r,!0))}),e.jsx("div",{ref:C})]}),s&&q&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-50 w-full max-w-3xl mx-auto p-2 bg-transparent",children:e.jsx(X,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(M),className:"w-full",children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-full px-2 py-1 bg-card/80 dark:bg-card/80 shadow-lg border border-border/50 backdrop-blur-md",children:[e.jsx(le,{isOpen:P,onOpenChange:V,onEmojiSelect:$,children:e.jsx(_,{type:"button",variant:"ghost",size:"icon",className:"flex-shrink-0 w-8 h-8 rounded-full text-muted-foreground hover:bg-accent hover:text-accent-foreground","aria-label":"Open emoji picker",children:e.jsx(de,{className:"w-4 h-4"})})}),e.jsx(G,{control:m.control,name:"replyContent",render:({field:a})=>e.jsxs(J,{className:"flex-1",children:[e.jsx(Q,{children:e.jsx(W,{placeholder:"Type a message...",...a,rows:1,className:"w-full min-h-0 resize-none border-none focus-visible:ring-0 focus-visible:ring-offset-0 bg-transparent shadow-none p-0 py-1 h-auto text-foreground",onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),m.handleSubmit(M)())}})}),e.jsx(A,{className:"hidden"})]})}),U&&e.jsx(_,{type:"button",variant:"ghost",size:"icon",className:"flex-shrink-0 w-8 h-8 rounded-full text-destructive hover:bg-destructive/20",onClick:z,"aria-label":"Close message",children:e.jsx(ce,{className:"w-4 h-4"})}),e.jsx(_,{type:"submit",variant:"default",size:"icon",className:"rounded-full flex-shrink-0 w-8 h-8 bg-primary hover:bg-primary/90 text-primary-foreground",disabled:!m.formState.isValid||m.formState.isSubmitting,children:e.jsx(me,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"px-4 pt-1",children:e.jsx(A,{className:"text-xs text-destructive",children:(R=m.formState.errors.replyContent)==null?void 0:R.message})})]})})})]})})]})};export{ke as default};
