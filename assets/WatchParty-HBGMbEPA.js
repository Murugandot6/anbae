import{c as q,j as e,r as t,L as pe,B as D,s as _,d as z,X as ge,a as $,b as te,i as B,m as be,H as Q,w as we}from"./main-CivNnYL8.js";import{A as re}from"./arrow-left-CxyQXc3_.js";import{R as ye}from"./index-D4dw0keJ.js";import{H as ve}from"./heart-BgHym6Ti.js";import{M as je}from"./message-square-CoPKz17q.js";import{L as Ne}from"./log-out-CIp6zt3s.js";import{B as Z}from"./BackgroundWrapper-iiVBtvC3.js";import"./index-Chjiymov.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=q("Angry",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M16 16s-1.5-2-4-2-4 2-4 2",key:"epbg0q"}],["path",{d:"M7.5 8 10 9",key:"olxxln"}],["path",{d:"m14 9 2.5-1",key:"1j6cij"}],["path",{d:"M9 10h.01",key:"qbtxuw"}],["path",{d:"M15 10h.01",key:"1qmjsl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=q("Flame",[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=q("Frown",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M16 16s-1.5-2-4-2-4 2-4 2",key:"epbg0q"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=q("Laugh",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M18 13a6 6 0 0 1-6 5 6 6 0 0 1-6-5h12Z",key:"b2q4dd"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=q("PartyPopper",[["path",{d:"M5.8 11.3 2 22l10.7-3.79",key:"gwxi1d"}],["path",{d:"M4 3h.01",key:"1vcuye"}],["path",{d:"M22 8h.01",key:"1mrtc2"}],["path",{d:"M15 2h.01",key:"1cjtqr"}],["path",{d:"M22 20h.01",key:"1mrys2"}],["path",{d:"m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10",key:"hbicv8"}],["path",{d:"m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11c-.11.7-.72 1.22-1.43 1.22H17",key:"1i94pl"}],["path",{d:"m11 2 .33.82c.34.86-.2 1.82-1.11 1.98C9.52 4.9 9 5.52 9 6.23V7",key:"1cofks"}],["path",{d:"M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z",key:"4kbmks"}]]),Te=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 4h7a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V5a1 1 0 011-1zm12 0h1a1 1 0 011 1v2a1 1 0 01-1 1h-1a1 1 0 01-1-1V5a1 1 0 011-1zm-1 8h1a1 1 0 011 1v2a1 1 0 01-1 1h-1a1 1 0 01-1-1v-2a1 1 0 011-1zm-11 0h1a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2a1 1 0 011-1z"})}),X=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),K=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"})}),Se=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),Le=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M8 5v14l11-7z"})}),Re=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"})}),Pe=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"})}),De=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L7 9.27 12 4.27V4z"})}),ze=({className:s})=>e.jsx("svg",{className:s,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 8V4h4M20 8V4h-4M4 16v4h4M20 16v4h-4"})}),Ie=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),Ve=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"})}),Be=({className:s})=>e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),ee=s=>({id:s.id,title:`Room ${s.room_code}`,videoUrl:s.video_url,room_code:s.room_code}),$e=()=>{const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let r="";for(let n=0;n<6;n++)r+=s.charAt(Math.floor(Math.random()*s.length));return r},qe=({onJoinRoom:s})=>{const[r,n]=t.useState(""),[m,g]=t.useState(null),[c,h]=t.useState(null),N=async()=>{g("create"),h(null);let u="",i=!1,f=0;for(;!i&&f<10;){u=$e();const{data:C,error:p}=await _.from("watch_party_rooms").select("id").eq("room_code",u).single();if(p&&p.code==="PGRST116")i=!0;else if(p){console.error("Error checking for room code uniqueness:",p),h("Could not verify room code. Please try again."),g(null);return}f++}if(!i){h("Failed to generate a unique room code. Please try again."),g(null);return}const{data:x,error:b}=await _.from("watch_party_rooms").insert({room_code:u,video_url:"",playback_status:"unstarted"}).select().single();b?(console.error("Error creating room:",b),h("Could not create a room. Please try again.")):x&&s(ee(x)),g(null)},E=async u=>{if(u.preventDefault(),!r.trim()){h("Please enter a room code.");return}g("join"),h(null);const i=r.trim().toUpperCase(),{data:f,error:x}=await _.from("watch_party_rooms").select("*").eq("room_code",i).single();x||!f?h(`Room with code "${i}" not found.`):s(ee(f)),g(null)};return e.jsxs("div",{className:"max-w-md sm:max-w-4xl mx-auto px-4",children:[" ",e.jsxs("div",{className:"flex justify-between items-center mb-6 sm:mb-8",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(pe,{to:"/dashboard",className:"flex items-center justify-center bg-card/60 backdrop-blur-md border border-border/50 hover:bg-accent/60 text-foreground p-2.5 sm:p-3 rounded-full transition-colors shadow-md","aria-label":"Back to Dashboard",children:e.jsx(re,{className:"h-4 w-4 sm:h-5 sm:w-5"})})}),e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold tracking-tighter text-foreground mx-auto",children:"Theater"}),e.jsx("div",{className:"flex-shrink-0 w-9 sm:w-10"})," "]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-8",children:[" ",e.jsxs("div",{className:"bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg p-6 sm:p-8 flex flex-col items-center text-center transition-all duration-300 hover:shadow-xl hover:scale-[1.02]",children:[e.jsx("div",{className:"bg-primary/20 p-3 sm:p-4 rounded-full mb-3 sm:mb-4",children:e.jsx(X,{className:"h-8 w-8 sm:h-10 sm:w-10 text-primary"})}),e.jsx("h2",{className:"text-xl sm:text-2xl text-foreground font-semibold mb-2",children:"Start a New Theater"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground mb-5 sm:mb-6",children:"Create a private room and get a shareable code. You can add a video once you're inside."}),e.jsxs("div",{className:"w-full flex flex-col gap-3 sm:gap-4",children:[c&&e.jsx("p",{className:"text-destructive text-xs sm:text-sm mt-2",children:c}),e.jsxs(D,{onClick:N,disabled:!!m,className:"w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-primary-foreground font-bold px-5 py-2.5 sm:px-6 sm:py-3 rounded-lg transition-all transform hover:scale-105 disabled:bg-primary/50 disabled:cursor-not-allowed text-sm sm:text-base",children:[e.jsx(X,{className:"h-5 w-5 sm:h-6 sm:w-6"}),m==="create"?"Creating...":"Create Private Room"]})]})]}),e.jsxs("div",{className:"bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg p-6 sm:p-8 flex flex-col items-center text-center transition-all duration-300 hover:shadow-xl hover:scale-[1.02]",children:[e.jsx("div",{className:"bg-secondary/20 p-3 sm:p-4 rounded-full mb-3 sm:mb-4",children:e.jsx(K,{className:"h-8 w-8 sm:h-10 sm:w-10 text-secondary"})}),e.jsx("h2",{className:"text-xl sm:text-2xl text-foreground font-semibold mb-2",children:"Join an Existing Theater"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground mb-5 sm:mb-6",children:"Enter the 6-character code your friend gave you."}),e.jsxs("form",{onSubmit:E,className:"w-full flex flex-col gap-3 sm:gap-4",children:[e.jsx("input",{type:"text",value:r,onChange:u=>{n(u.target.value.toUpperCase()),c&&h(null)},placeholder:"ABC-123",maxLength:7,className:"w-full text-center text-lg sm:text-xl tracking-widest font-mono px-3 py-2.5 sm:px-4 sm:py-3 bg-input/50 border border-border/50 rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary transition",required:!0,disabled:!!m}),c&&e.jsx("p",{className:"text-destructive text-xs sm:text-sm",children:c}),e.jsxs(D,{type:"submit",disabled:!!m,className:"w-full flex items-center justify-center gap-2 bg-secondary hover:bg-secondary/90 text-secondary-foreground font-bold px-5 py-2.5 sm:px-6 sm:py-3 rounded-lg transition-all transform hover:scale-105 disabled:bg-secondary/50 disabled:cursor-not-allowed text-sm sm:text-base",children:[e.jsx(K,{className:"h-5 w-5 sm:h-6 sm:w-6"}),m==="join"?"Joining...":"Join With Code"]})]})]})]})]})},oe=({messages:s,sendMessage:r,currentUser:n,isOverlay:m,onClose:g})=>{const[c,h]=t.useState(""),N=t.useRef(null),E=()=>{var i;(i=N.current)==null||i.scrollIntoView({behavior:"smooth"})};t.useEffect(E,[s]);const u=i=>{i.preventDefault(),c.trim()&&(r(c.trim()),h(""))};return e.jsxs("div",{className:z("flex flex-col h-full min-h-0",m?"backdrop-blur-md rounded-xl shadow-lg":"backdrop-blur-md border border-border/50 rounded-xl shadow-lg"),children:[e.jsxs("div",{className:z("flex-shrink-0 flex items-center justify-between p-3 sm:p-4 border-b border-border/50",m?"bg-card/50 rounded-t-xl":""),children:[" ",e.jsx("h3",{className:"text-lg sm:text-xl font-bold text-foreground",children:"Live Chat"})," ",m&&g&&e.jsx(D,{variant:"ghost",size:"icon",onClick:g,className:"w-8 h-8 text-muted-foreground hover:text-foreground hover:bg-accent/20","aria-label":"Close chat",children:e.jsx(ge,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-grow p-3 sm:p-4 overflow-y-auto space-y-3 sm:space-y-4",children:[" ",s.map(i=>e.jsxs("div",{className:`flex items-start gap-2 ${i.isSystem?"justify-center":""} ${i.author===n.name?"justify-end":""}`,children:[" ",i.isSystem?e.jsx("span",{className:"text-xs text-center text-muted-foreground italic px-2 py-1 bg-muted/20 rounded-full",children:i.text}):e.jsxs("div",{className:`flex flex-col w-full max-w-[280px] sm:max-w-[320px] leading-1.5 p-2.5 sm:p-3 border-border/50 rounded-xl shadow-sm ${i.author===n.name?"bg-primary text-primary-foreground rounded-br-none":"bg-muted/20 text-foreground rounded-bl-none"}`,children:[" ",e.jsxs("div",{className:"flex items-center space-x-1.5 sm:space-x-2 rtl:space-x-reverse",children:[" ",e.jsx("span",{className:"text-xs sm:text-sm font-semibold text-foreground",children:i.author})," ",e.jsx("span",{className:"text-xs font-normal text-muted-foreground",children:new Date(i.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm font-normal py-1.5 sm:py-2 text-foreground",children:i.text})," "]})]},i.id)),e.jsx("div",{ref:N})]}),e.jsxs("form",{onSubmit:u,className:z("flex-shrink-0 p-3 sm:p-4 border-t border-border/50",m?"bg-card/50 rounded-b-xl":""),children:[" ",e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:c,onChange:i=>h(i.target.value),placeholder:"Say something...",className:"flex-grow px-3 py-2 bg-input/50 border border-border/50 rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary transition text-sm sm:text-base"}),e.jsxs("button",{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground p-2.5 sm:p-3 rounded-lg transition-colors",children:[" ",e.jsx(Se,{className:"w-4 h-4 sm:w-5 h-5"})," "]})]})]})]})},se=s=>{if(isNaN(s)||s<0)return"00:00";const r=Math.floor(s/60).toString().padStart(2,"0"),n=Math.floor(s%60).toString().padStart(2,"0");return`${r}:${n}`},Ue=({videoState:s,sendVideoAction:r,messages:n,sendMessage:m,currentUser:g,sendVideoReaction:c,activeReactions:h,isConnectedToRealtime:N,onToggleFullscreen:E,isTheaterFullscreen:u,className:i})=>{const f=t.useRef(null),[x,b]=t.useState(!0),[C,p]=t.useState(.8),[T,y]=t.useState(!0),I=t.useRef(null),[R,j]=t.useState(!1),[d,l]=t.useState(0),[o,S]=t.useState(s.time),[k,P]=t.useState(!1),[w,F]=t.useState(null),J=t.useRef(!1),V=t.useRef(null),[ae,H]=t.useState(!1),A=R?d:o;t.useEffect(()=>{if(S(s.time),s.isPlaying){const a=setInterval(()=>{const v=(Date.now()-s.timestamp)/1e3,L=Math.min(s.time+v,s.duration);S(L)},250);return()=>clearInterval(a)}},[s.isPlaying,s.time,s.timestamp,s.duration]),t.useEffect(()=>{const a=f.current;if(!k||R||!a)return;let v=s.time;if(s.isPlaying){const fe=(Date.now()-s.timestamp)/1e3;v=s.time+fe}const L=a.getCurrentTime();Math.abs(L-v)>1&&(J.current=!0,a.seekTo(v,"seconds"))},[s,k,R]),t.useEffect(()=>{H(u)},[u]);const Y=()=>{var v;if(!k)return;const a=((v=f.current)==null?void 0:v.getCurrentTime())??s.time;r({type:s.isPlaying?"pause":"play",payload:a})},ne=t.useCallback(a=>{V.current===null&&(r({type:"seek",payload:a}),V.current=window.setTimeout(()=>{V.current=null},200))},[r]),le=()=>{var a;!k||w||(j(!0),l(A),s.isPlaying&&r({type:"pause",payload:((a=f.current)==null?void 0:a.getCurrentTime())??s.time}))},ie=a=>{if(!k||w)return;const v=parseFloat(a.target.value);l(v),ne(v)},de=a=>{if(!k||w)return;V.current&&(window.clearTimeout(V.current),V.current=null);const v=parseFloat(a.currentTarget.value);j(!1),r({type:"seek",payload:v})},ce=a=>{const v=parseFloat(a.target.value);p(v),b(v===0)},me=()=>{b(a=>!a)},ue=()=>{E()},U=t.useCallback(()=>{y(!0),I.current&&window.clearTimeout(I.current),I.current=window.setTimeout(()=>{s.isPlaying&&!u&&y(!1)},3e3)},[s.isPlaying,u]),G=t.useRef(null);t.useEffect(()=>{const a=G.current;return a==null||a.addEventListener("mousemove",U),()=>a==null?void 0:a.removeEventListener("mousemove",U)},[U]);const xe=()=>{},he=a=>{J.current=!1,S(a)},M=!k||!!w||!N;return e.jsx("div",{ref:G,className:z("relative w-full bg-black rounded-xl overflow-hidden group shadow-lg",i),children:s.source?e.jsxs(e.Fragment,{children:[e.jsx(ye,{ref:f,url:s.source,width:"100%",height:"100%",playing:s.isPlaying,volume:C,muted:x,controls:!1,onReady:()=>P(!0),onDuration:a=>r({type:"durationchange",payload:a}),onProgress:xe,onSeek:he,progressInterval:500,onError:(a,v)=>{var O;let L="Could not load video. The URL may be invalid, the video is private, or the format is not supported.";const W=typeof v=="number"?v:typeof a=="number"?a:null;if(W!==null)switch(W){case 2:L="The video request contains an invalid parameter. Please check the URL.";break;case 5:L="An HTML5 player error occurred. The video may not be compatible.";break;case 100:case 101:case 150:L="The video owner has disabled playback on other websites. Please choose another video.";break}else a instanceof Error?L=a.message:typeof a=="string"&&a.length>0&&(L=a);F(L),s.isPlaying&&r({type:"pause",payload:(O=f.current)==null?void 0:O.getCurrentTime()})}}),!k&&!w&&e.jsxs("div",{className:"absolute inset-0 bg-black flex flex-col items-center justify-center z-30",children:[e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"})," ",e.jsx("p",{className:"mt-3 sm:mt-4 text-white text-sm sm:text-base",children:"Loading Player..."})," "]}),w&&e.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-30 p-4 text-center",children:[e.jsx("p",{className:"text-destructive text-base sm:text-lg font-semibold",children:"Video Error"})," ",e.jsx("p",{className:"text-muted-foreground mt-1 sm:mt-2 text-sm sm:text-base",children:w})," "]}),e.jsx("div",{className:z("absolute inset-0 w-full h-full z-10",M?"cursor-not-allowed":"cursor-pointer"),onClick:Y,onMouseMove:U}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-20",children:h.map(a=>e.jsx("span",{className:z("absolute text-5xl sm:text-6xl md:text-8xl animate-fade-in-out"),style:{animationDuration:"5s",top:`${Math.random()*80+10}%`,left:`${Math.random()*80+10}%`},children:a.emoji},a.id))}),u&&ae&&e.jsxs("div",{className:"absolute inset-y-0 right-0 w-full sm:w-[320px] z-40",children:[" ",e.jsx(oe,{messages:n,sendMessage:m,currentUser:g,isOverlay:!0,onClose:()=>H(!1)})]}),e.jsxs("div",{className:z("absolute bottom-0 left-0 right-0 p-3 sm:p-4 bg-gradient-to-t from-black/70 to-transparent transition-opacity duration-300 z-20",T||u?"opacity-100":"opacity-0"),children:[" ",e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("input",{type:"range",min:"0",max:s.duration||100,step:"0.1",value:A,onMouseDown:le,onChange:ie,onMouseUp:de,disabled:M,className:"w-full h-1 bg-muted rounded-lg appearance-none cursor-pointer range-sm accent-primary disabled:bg-muted/50 disabled:accent-muted-foreground disabled:cursor-not-allowed"}),e.jsxs("div",{className:"flex items-center justify-between text-white",children:[e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[" ",e.jsxs("button",{onClick:Y,disabled:M,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[s.isPlaying?e.jsx(Re,{className:"w-5 h-5 sm:w-6 sm:h-6"}):e.jsx(Le,{className:"w-5 h-5 sm:w-6 sm:h-6"})," "]}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[" ",e.jsxs("button",{onClick:me,disabled:M,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[x?e.jsx(De,{className:"w-5 h-5 sm:w-6 sm:h-6"}):e.jsx(Pe,{className:"w-5 h-5 sm:w-6 sm:h-6"})," "]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.05",value:x?0:C,onChange:ce,disabled:M,className:"w-16 sm:w-20 h-1 bg-muted rounded-lg appearance-none cursor-pointer range-sm accent-primary disabled:bg-muted/50 disabled:accent-muted-foreground disabled:cursor-not-allowed"})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[" ",e.jsxs("button",{onClick:()=>c("❤️"),disabled:M,className:"hover:text-red-500 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[e.jsx(ve,{className:"w-5 h-5 sm:w-6 sm:h-6"})," "]}),e.jsxs("button",{onClick:()=>c("😂"),disabled:M,className:"hover:text-yellow-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[e.jsx(Me,{className:"w-5 h-5 sm:w-6 sm:h-6"})," "]}),e.jsxs("button",{onClick:()=>c("😭"),disabled:M,className:"hover:text-blue-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[e.jsx(Ce,{className:"w-5 h-5 sm:w-6 sm:h-6"})," "]}),e.jsxs("button",{onClick:()=>c("😡"),disabled:M,className:"hover:text-red-600 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[e.jsx(ke,{className:"w-5 h-5 sm:w-6 sm:h-6"})," "]}),e.jsxs("button",{onClick:()=>c("🔥"),disabled:M,className:"hover:text-orange-500 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[e.jsx(_e,{className:"w-5 h-5 sm:w-6 sm:h-6"})," "]}),e.jsxs("button",{onClick:()=>c("🎉"),disabled:M,className:"hover:text-purple-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[e.jsx(Ee,{className:"w-5 h-5 sm:w-6 sm:h-6"})," "]})]}),e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[" ",e.jsxs("span",{className:"text-xs sm:text-sm font-mono text-muted-foreground",children:[se(A)," / ",se(s.duration)]})," ",u&&e.jsxs("button",{onClick:()=>H(a=>!a),disabled:M,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[e.jsx(je,{className:"w-4 h-4 sm:w-5 h-5"})," "]}),e.jsxs("button",{onClick:ue,disabled:M,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:[e.jsx(ze,{className:"w-4 h-4 sm:w-5 h-5"})," "]})]})]})]})]})]}):e.jsxs("div",{className:"absolute inset-0 bg-black flex flex-col items-center justify-center z-30 p-4 text-center",children:[e.jsx(Te,{className:"w-12 h-12 sm:w-16 sm:h-16 text-muted-foreground mb-3 sm:mb-4"})," ",e.jsx("h3",{className:"text-base sm:text-xl font-bold text-foreground",children:"No Video Selected"})," ",e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground mt-1 sm:mt-2",children:'To start the party, paste a video URL in the field above and click "Set Video".'})," "]})})},Fe=(s,r)=>{switch(r.type){case"play":return{...s,isPlaying:!0,time:r.payload};case"pause":return{...s,isPlaying:!1,time:r.payload};case"seek":return{...s,time:r.payload};case"durationchange":return r.payload>0&&s.duration!==r.payload?{...s,duration:r.payload}:s;case"source":return{...s,source:r.payload,time:0,isPlaying:!1,duration:0};default:return s}},He=(s,r,n)=>{const[m,g]=t.useState({isPlaying:!1,time:0,source:r,duration:0,timestamp:Date.now()}),[c,h]=t.useState([]),[N,E]=t.useState([]),[u,i]=t.useState([]),[f,x]=t.useState(!1),b=t.useRef(null),C=t.useRef(m);t.useEffect(()=>{C.current=m},[m]);const p=t.useCallback(j=>{const d={id:`sys_${Date.now()}`,author:"System",text:j,timestamp:Date.now(),isSystem:!0};h(l=>[...l,d])},[]);t.useEffect(()=>{(async()=>{const{data:l,error:o}=await _.from("watch_party_chat_messages").select("*").eq("room_id",s).order("created_at",{ascending:!0});if(o)p(`Failed to load chat history: ${o.message}`);else{const P=l.map(w=>({id:w.id,author:w.author_name,text:w.text,timestamp:new Date(w.created_at).getTime()}));h(P)}const{data:S,error:k}=await _.from("watch_party_video_history").select("*").eq("room_id",s).order("created_at",{ascending:!1});if(k)p(`Failed to load video history: ${k.message}`);else{const P=S.map(w=>({id:w.id,videoUrl:w.video_url,addedBy:w.user_name,timestamp:new Date(w.created_at).getTime()}));E(w=>[...P,...w])}})();const d=_.channel(`room:${s}_v1`,{config:{presence:{key:n.id}}});return b.current=d,d.on("postgres_changes",{event:"INSERT",schema:"public",table:"watch_party_chat_messages",filter:`room_id=eq.${s}`},l=>{const o=l.new;h(S=>[...S,{id:o.id,author:o.author_name,text:o.text,timestamp:new Date(o.created_at).getTime()}])}),d.on("postgres_changes",{event:"INSERT",schema:"public",table:"watch_party_video_history",filter:`room_id=eq.${s}`},l=>{const o=l.new,S={id:o.id,videoUrl:o.video_url,addedBy:o.user_name,timestamp:new Date(o.created_at).getTime()};E(k=>[S,...k])}),d.on("postgres_changes",{event:"INSERT",schema:"public",table:"reactions",filter:`room_id=eq.${s}`},l=>{const{emoji:o,id:S}=l.new,k=`${o}-${S}`;i(P=>[...P,{id:k,emoji:o,timestamp:Date.now()}]),setTimeout(()=>{i(P=>P.filter(F=>F.id!==k))},5e3)}),d.on("broadcast",{event:"video_state_update"},({payload:l})=>{l.senderId!==n.id&&g(l.newState)}),d.on("broadcast",{event:"REQUEST_VIDEO_STATE"},({payload:l})=>{l.senderId!==n.id&&C.current&&d.send({type:"broadcast",event:"SYNC_VIDEO_STATE",payload:{videoState:C.current,senderId:n.id}})}),d.on("broadcast",{event:"SYNC_VIDEO_STATE"},({payload:l})=>{l.senderId!==n.id&&g(l.videoState)}),d.on("presence",{event:"join"},({newPresences:l})=>l.forEach(o=>{o.user_name&&p(`${o.user_name} joined.`)})),d.on("presence",{event:"leave"},({leftPresences:l})=>l.forEach(o=>{o.user_name&&p(`${o.user_name} left.`)})),d.subscribe(async(l,o)=>{l==="SUBSCRIBED"?(x(!0),await d.track({user_name:n.name,joined_at:new Date().toISOString()}),d.send({type:"broadcast",event:"REQUEST_VIDEO_STATE",payload:{senderId:n.id}})):(l==="CHANNEL_ERROR"||l==="TIMED_OUT"||l==="CLOSED")&&(x(!1),$.error(`Realtime connection lost: ${(o==null?void 0:o.message)||"Please refresh."}`))}),()=>{b.current&&(_.removeChannel(b.current),b.current=null,x(!1))}},[s,p,n.name,n.id]);const T=t.useCallback(j=>{g(d=>{const l=Fe(d,j);if(l===d)return d;const o={...l,timestamp:Date.now()};return b.current&&f&&b.current.send({type:"broadcast",event:"video_state_update",payload:{newState:o,senderId:n.id}}),o})},[n.id,f]),y=t.useCallback(async j=>{if(!f){$.error("Cannot send message: Not connected to room.");return}const{error:d}=await _.from("watch_party_chat_messages").insert({room_id:s,user_id:n.id,author_name:n.name,text:j});d&&p(`Could not send message: ${d.message}`)},[s,n.id,n.name,p,f]),I=t.useCallback(async j=>{if(!f){$.error("Cannot send reaction: Not connected to room.");return}const{error:d}=await _.from("reactions").insert({room_id:s,emoji:j});d&&$.error(`Failed to send reaction: ${d.message}`)},[s,f]),R=t.useCallback(async j=>{if(!j.trim())return;const{error:d}=await _.from("watch_party_rooms").update({video_url:j}).eq("id",s);if(d){p(`Error: Could not change video. ${d.message}`);return}const{error:l}=await _.from("watch_party_video_history").insert({room_id:s,user_id:n.id,user_name:n.name,video_url:j});T({type:"source",payload:j})},[s,n.id,n.name,T,p]);return{videoState:m,sendVideoAction:T,messages:c,sendMessage:y,sendVideoReaction:I,changeVideoSource:R,videoHistory:N,activeReactions:u,isConnectedToRealtime:f}},Ae=({history:s,onSelectVideo:r,className:n})=>{const[m,g]=t.useState(!1);return s.length===0?null:e.jsxs("div",{className:z("bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg",n),children:[e.jsxs(D,{onClick:()=>g(!m),className:"w-full flex justify-between items-center p-3 sm:p-4 text-left font-semibold text-foreground bg-transparent hover:bg-accent/20 rounded-xl h-auto",variant:"ghost",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[" ",e.jsx(Be,{className:"w-5 h-5 sm:w-6 h-6 text-muted-foreground"})," ",e.jsxs("span",{className:"text-sm sm:text-base",children:["Video History (",s.length,")"]})," "]}),e.jsx("svg",{className:`w-4 h-4 sm:w-5 h-5 transform transition-transform text-foreground ${m?"rotate-180":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),m&&e.jsxs("div",{className:"p-3 sm:p-4 border-t border-border/50 max-h-52 sm:max-h-60 overflow-y-auto",children:[" ",e.jsxs("ul",{className:"space-y-2 sm:space-y-3",children:[" ",s.map(c=>e.jsxs("li",{className:"flex items-center justify-between gap-2 p-2 bg-muted/20 rounded-lg border border-border/50 shadow-sm",children:[e.jsxs("div",{className:"flex-grow overflow-hidden",children:[e.jsx("p",{className:"text-xs sm:text-sm text-foreground truncate",title:c.videoUrl,children:c.videoUrl})," ",e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Added by ",c.addedBy]})]}),e.jsx(D,{onClick:()=>r(c.videoUrl),className:"flex-shrink-0 text-xs sm:text-sm bg-primary hover:bg-primary/90 text-primary-foreground font-semibold px-2.5 py-1 sm:px-3 sm:py-1.5 rounded-md transition-colors h-auto",size:"sm",children:"Watch"})]},c.id))]})]})]})},We=({room:s,user:r,onLeaveRoom:n})=>{const m=te(),{videoState:g,sendVideoAction:c,messages:h,sendMessage:N,sendVideoReaction:E,changeVideoSource:u,videoHistory:i,activeReactions:f,isConnectedToRealtime:x}=He(s.id,s.videoUrl,r),[b,C]=t.useState("Copy Code"),[p,T]=t.useState(""),[y,I]=t.useState(!1),R=t.useRef(null);t.useEffect(()=>{const o=()=>{I(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",o),document.addEventListener("webkitfullscreenchange",o),document.addEventListener("mozfullscreenchange",o),document.addEventListener("MSFullscreenChange",o),()=>{document.removeEventListener("fullscreenchange",o),document.removeEventListener("webkitfullscreenchange",o),document.removeEventListener("mozfullscreenchange",o),document.removeEventListener("MSFullscreenChange",o)}},[]);const j=t.useCallback(()=>{R.current&&(document.fullscreenElement?document.exitFullscreen():R.current.requestFullscreen().catch(o=>{$.error(`Error entering fullscreen: ${o.message}`)}))},[]),d=()=>{navigator.clipboard.writeText(s.room_code),C("Copied!"),$.success("Room code copied to clipboard!"),setTimeout(()=>C("Copy Code"),2e3)},l=o=>{o.preventDefault(),p.trim()&&(u(p.trim()),T(""))};return e.jsx("div",{ref:R,className:B("flex flex-col h-full",{"fullscreen:h-screen fullscreen:flex fullscreen:fixed fullscreen:inset-0 fullscreen:z-50 fullscreen:rounded-none":!0,"bg-background text-foreground":!y,"bg-black":y}),children:e.jsxs("div",{className:B("w-full flex flex-col flex-grow min-h-0 p-3 sm:p-4 md:p-6",{"max-w-full mx-0":y}),children:[!y&&e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 sm:mb-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between w-full sm:w-auto mb-3 sm:mb-0",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(D,{onClick:()=>m("/dashboard"),variant:"outline",size:"icon",className:"w-9 h-9 sm:w-10 sm:h-10 text-foreground border-border hover:bg-accent hover:text-accent-foreground rounded-full shadow-md","aria-label":"Back to Dashboard",children:e.jsx(re,{className:"w-4 h-4 sm:w-5 sm:h-5"})})}),e.jsx("h1",{className:"text-xl sm:text-3xl font-bold tracking-tighter text-foreground ml-auto sm:ml-4",children:"Theater"})]}),e.jsxs("div",{className:"flex items-center justify-between w-full sm:w-auto gap-2 sm:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground hidden sm:inline",children:"Share Code:"}),e.jsx("p",{className:"text-sm sm:text-lg font-mono text-primary bg-input/50 px-2 py-0.5 sm:px-3 sm:py-1 rounded-md border border-border/50",children:s.room_code}),e.jsxs(D,{onClick:d,variant:"ghost",size:"sm",className:"flex items-center gap-1 sm:gap-1.5 text-xs sm:text-sm text-muted-foreground hover:text-foreground bg-input/50 hover:bg-accent/50 px-2 py-0.5 sm:px-3 sm:py-1 rounded-md transition-colors h-auto",children:[e.jsx(Ie,{className:"h-3 w-3 sm:h-4 sm:w-4"}),b]})]}),e.jsx(D,{onClick:n,variant:"destructive",size:"icon",className:"w-9 h-9 sm:w-10 sm:h-10 bg-destructive hover:bg-destructive/90 text-destructive-foreground rounded-full shadow-md",children:e.jsx(Ne,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]})]}),e.jsxs("div",{className:B("flex flex-col sm:flex-row items-stretch min-h-0 gap-6 sm:gap-8 flex-grow",{"h-full":y,"h-[calc(100vh-120px)]":!y}),children:[e.jsx("div",{className:B("relative w-full rounded-xl overflow-hidden flex-grow","h-full"),children:e.jsx(Ue,{videoState:g,sendVideoAction:c,messages:h,sendMessage:N,currentUser:r,sendVideoReaction:E,activeReactions:f,isConnectedToRealtime:x,onToggleFullscreen:j,isTheaterFullscreen:y,className:"w-full h-full"})}),!y&&e.jsx("div",{className:B("w-full flex flex-col min-h-[300px] sm:min-h-0","sm:w-[320px] sm:flex-shrink-0","h-full"),children:e.jsx(oe,{messages:h,sendMessage:N,currentUser:r})})]}),!y&&e.jsxs("div",{className:"flex flex-col gap-4 sm:gap-6 mt-6 sm:mt-8 flex-shrink-0",children:[e.jsxs("form",{onSubmit:l,className:B("bg-card/60 backdrop-blur-md border border-border/50 p-3 sm:p-4 rounded-xl flex flex-col sm:flex-row items-center gap-2 sm:gap-3 shadow-lg"),children:[e.jsx("label",{htmlFor:"video-url-input",className:"font-semibold text-foreground sr-only",children:"Video URL"}),e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none",children:[" ",e.jsx(Ve,{className:"w-4 h-4 sm:w-5 sm:h-5 text-muted-foreground"})," "]}),e.jsx("input",{id:"video-url-input",type:"url",value:p,onChange:o=>{T(o.target.value)},placeholder:"Enter YouTube or video URL to start or change the video",className:"w-full bg-input/50 border border-border/50 text-foreground text-xs sm:text-sm rounded-lg focus:ring-primary focus:border-primary block ps-9 p-2 sm:ps-10 sm:p-2.5",required:!0})]}),e.jsxs(D,{type:"submit",className:"w-full sm:w-auto bg-primary hover:bg-primary/90 text-primary-foreground font-medium rounded-lg text-xs sm:text-sm px-4 py-2 sm:px-5 sm:py-2.5 text-center h-auto",children:[" ","Set Video"]})]}),e.jsx("div",{children:e.jsx(Ae,{history:i,onSelectVideo:u,className:"flex-shrink-0"})})]})]})})},Oe=()=>e.jsx("div",{className:"min-h-screen flex flex-col items-center justify-center bg-background text-foreground",children:e.jsx(we,{})}),Je=s=>({id:s.id,title:`Room ${s.room_code}`,videoUrl:s.video_url,room_code:s.room_code}),ts=()=>{const{session:s,user:r,loading:n}=be(),m=te(),[g,c]=t.useState(null),[h,N]=t.useState(null),[E,u]=t.useState(!0);t.useEffect(()=>{var x;s&&r?c({id:r.id,name:r.user_metadata.nickname||((x=r.email)==null?void 0:x.split("@")[0])||"Guest",email:r.email}):(c(null),N(null))},[s,r]),t.useEffect(()=>{(async()=>{if(!n&&r){const{data:b,error:C}=await _.from("profiles").select("last_watch_party_room_id").eq("id",r.id).single();C&&C.code!=="PGRST116"&&console.error("Error fetching user profile for watch party:",C.message);const p=b==null?void 0:b.last_watch_party_room_id;if(p){const{data:T,error:y}=await _.from("watch_party_rooms").select("*").eq("id",p).single();y||!T?(console.error("Error loading persisted room from DB:",y==null?void 0:y.message),await _.from("profiles").update({last_watch_party_room_id:null}).eq("id",r.id),N(null)):N(Je(T))}}u(!1)})()},[n,r]);const i=t.useCallback(async x=>{if(N(x),r){const{error:b}=await _.from("profiles").update({last_watch_party_room_id:x.id}).eq("id",r.id);b&&console.error("Error saving last room ID to profile:",b.message)}},[r]),f=t.useCallback(async()=>{if(N(null),r){const{error:x}=await _.from("profiles").update({last_watch_party_room_id:null}).eq("id",r.id);x&&console.error("Error clearing last room ID from profile:",x.message)}m("/dashboard")},[m,r]);return n||E?e.jsx(Oe,{}):g?e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx("title",{children:"Theater - Anbae"}),e.jsx("meta",{name:"description",content:"Join or create a theater to watch videos with your partner in real-time."})]}),e.jsx(Z,{className:"pt-0 md:pt-0",solid:!0,children:e.jsx("main",{className:"flex-grow min-h-0 w-full p-0",children:h?e.jsx(We,{room:h,onLeaveRoom:f,user:g}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-4xl sm:text-5xl font-bold tracking-tighter mb-6 sm:mb-8 text-foreground text-center",children:"Theater"}),e.jsx(qe,{onJoinRoom:i})]})})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx("title",{children:"Theater - Anbae"}),e.jsx("meta",{name:"description",content:"Join or create a theater to watch videos with your partner in real-time."})]}),e.jsx(Z,{solid:!0,children:e.jsxs("div",{className:"w-full max-w-sm sm:max-w-md bg-card/60 backdrop-blur-md border border-border/50 p-6 sm:p-8 rounded-xl shadow-lg text-center",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-foreground",children:"Authentication Error"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:"Could not find a valid user session. Please ensure you are logged in."})]})})]})};export{ts as default};
