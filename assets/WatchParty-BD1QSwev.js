import{c as U,j as e,r as t,L as xe,B as P,s as _,d as I,X as fe,a as B,b as te,h as $,l as ge,H as Q}from"./main-BHPIGV8h.js";import{A as se}from"./arrow-left-C4HDbgt0.js";import{R as pe}from"./index-rTFgChZ3.js";import{H as be}from"./heart-C5xyn10g.js";import{M as ye}from"./message-square-vNVwtfba.js";import{L as we}from"./log-out-zivWoyqF.js";import{B as Z}from"./BackgroundWrapper-C6a75pID.js";import"./index-Chjiymov.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=U("Angry",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M16 16s-1.5-2-4-2-4 2-4 2",key:"epbg0q"}],["path",{d:"M7.5 8 10 9",key:"olxxln"}],["path",{d:"m14 9 2.5-1",key:"1j6cij"}],["path",{d:"M9 10h.01",key:"qbtxuw"}],["path",{d:"M15 10h.01",key:"1qmjsl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=U("Flame",[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=U("Frown",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M16 16s-1.5-2-4-2-4 2-4 2",key:"epbg0q"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=U("Laugh",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M18 13a6 6 0 0 1-6 5 6 6 0 0 1-6-5h12Z",key:"b2q4dd"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=U("PartyPopper",[["path",{d:"M5.8 11.3 2 22l10.7-3.79",key:"gwxi1d"}],["path",{d:"M4 3h.01",key:"1vcuye"}],["path",{d:"M22 8h.01",key:"1mrtc2"}],["path",{d:"M15 2h.01",key:"1cjtqr"}],["path",{d:"M22 20h.01",key:"1mrys2"}],["path",{d:"m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10",key:"hbicv8"}],["path",{d:"m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11c-.11.7-.72 1.22-1.43 1.22H17",key:"1i94pl"}],["path",{d:"m11 2 .33.82c.34.86-.2 1.82-1.11 1.98C9.52 4.9 9 5.52 9 6.23V7",key:"1cofks"}],["path",{d:"M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z",key:"4kbmks"}]]),Ce=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 4h7a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V5a1 1 0 011-1zm12 0h1a1 1 0 011 1v2a1 1 0 01-1 1h-1a1 1 0 01-1-1V5a1 1 0 011-1zm-1 8h1a1 1 0 011 1v2a1 1 0 01-1 1h-1a1 1 0 01-1-1v-2a1 1 0 011-1zm-11 0h1a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2a1 1 0 011-1z"})}),X=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),K=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"})}),Ee=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),Re=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M8 5v14l11-7z"})}),Me=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"})}),Se=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"})}),Te=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L7 9.27 12 4.27V4z"})}),Le=({className:r})=>e.jsx("svg",{className:r,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 8V4h4M20 8V4h-4M4 16v4h4M20 16v4h-4"})}),De=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),Pe=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"})}),$e=({className:r})=>e.jsx("svg",{className:r,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),ee=r=>({id:r.id,title:`Room ${r.room_code}`,videoUrl:r.video_url,room_code:r.room_code}),Ie=()=>{const r="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let s="";for(let l=0;l<6;l++)s+=r.charAt(Math.floor(Math.random()*r.length));return s},Ve=({onJoinRoom:r})=>{const[s,l]=t.useState(""),[u,w]=t.useState(null),[d,f]=t.useState(null),N=async()=>{w("create"),f(null);let g="",c=!1,p=0;for(;!c&&p<10;){g=Ie();const{data:C,error:b}=await _.from("watch_party_rooms").select("id").eq("room_code",g).single();if(b&&b.code==="PGRST116")c=!0;else if(b){console.error("Error checking for room code uniqueness:",b),f("Could not verify room code. Please try again."),w(null);return}p++}if(!c){f("Failed to generate a unique room code. Please try again."),w(null);return}const{data:x,error:y}=await _.from("watch_party_rooms").insert({room_code:g,video_url:"",playback_status:"unstarted"}).select().single();y?(console.error("Error creating room:",y),f("Could not create a room. Please try again.")):x&&r(ee(x)),w(null)},R=async g=>{if(g.preventDefault(),!s.trim()){f("Please enter a room code.");return}w("join"),f(null);const c=s.trim().toUpperCase(),{data:p,error:x}=await _.from("watch_party_rooms").select("*").eq("room_code",c).single();x||!p?f(`Room with code "${c}" not found.`):r(ee(p)),w(null)};return e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(xe,{to:"/dashboard",className:"flex items-center justify-center bg-card/60 backdrop-blur-md border border-border/50 hover:bg-accent/60 text-foreground p-3 rounded-full transition-colors shadow-md","aria-label":"Back to Dashboard",children:e.jsx(se,{className:"h-5 w-5"})})}),e.jsx("h1",{className:"text-3xl font-bold tracking-tighter text-foreground mx-auto",children:"Watch Party"}),e.jsx("div",{className:"flex-shrink-0 w-10"})," "]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg p-8 flex flex-col items-center text-center transition-all duration-300 hover:shadow-xl hover:scale-[1.02]",children:[e.jsx("div",{className:"bg-primary/20 p-4 rounded-full mb-4",children:e.jsx(X,{className:"h-10 w-10 text-primary"})}),e.jsx("h2",{className:"text-2xl text-foreground font-semibold mb-2",children:"Start a New Party"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Create a private room and get a shareable code. You can add a video once you're inside."}),e.jsxs("div",{className:"w-full flex flex-col gap-4",children:[d&&e.jsx("p",{className:"text-destructive text-sm mt-2",children:d}),e.jsxs(P,{onClick:N,disabled:!!u,className:"w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-primary-foreground font-bold px-6 py-3 rounded-lg transition-all transform hover:scale-105 disabled:bg-primary/50 disabled:cursor-not-allowed",children:[e.jsx(X,{className:"h-6 w-6"}),u==="create"?"Creating...":"Create Private Room"]})]})]}),e.jsxs("div",{className:"bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg p-8 flex flex-col items-center text-center transition-all duration-300 hover:shadow-xl hover:scale-[1.02]",children:[e.jsx("div",{className:"bg-secondary/20 p-4 rounded-full mb-4",children:e.jsx(K,{className:"h-10 w-10 text-secondary"})}),e.jsx("h2",{className:"text-2xl text-foreground font-semibold mb-2",children:"Join an Existing Party"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Enter the 6-character code your friend gave you."}),e.jsxs("form",{onSubmit:R,className:"w-full flex flex-col gap-4",children:[e.jsx("input",{type:"text",value:s,onChange:g=>{l(g.target.value.toUpperCase()),d&&f(null)},placeholder:"ABC-123",maxLength:7,className:"w-full text-center text-xl tracking-widest font-mono px-4 py-3 bg-input/50 border border-border/50 rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary transition",required:!0,disabled:!!u}),d&&e.jsx("p",{className:"text-destructive text-sm",children:d}),e.jsxs(P,{type:"submit",disabled:!!u,className:"w-full flex items-center justify-center gap-2 bg-secondary hover:bg-secondary/90 text-secondary-foreground font-bold px-6 py-3 rounded-lg transition-all transform hover:scale-105 disabled:bg-secondary/50 disabled:cursor-not-allowed",children:[e.jsx(K,{className:"h-6 w-6"}),u==="join"?"Joining...":"Join With Code"]})]})]})]})]})},re=r=>{if(isNaN(r)||r<0)return"00:00";const s=Math.floor(r/60).toString().padStart(2,"0"),l=Math.floor(r%60).toString().padStart(2,"0");return`${s}:${l}`},ze=({videoState:r,sendVideoAction:s,messages:l,sendMessage:u,currentUser:w,sendVideoReaction:d,activeReactions:f,isConnectedToRealtime:N,onToggleFullscreen:R,isTheaterFullscreen:g,className:c})=>{const p=t.useRef(null),[x,y]=t.useState(!0),[C,b]=t.useState(.8),[M,m]=t.useState(!0),V=t.useRef(null),[L,j]=t.useState(!1),[i,n]=t.useState(0),[o,S]=t.useState(r.time),[k,D]=t.useState(!1),[h,F]=t.useState(null),O=t.useRef(!1),z=t.useRef(null),[Oe,J]=t.useState(!1),H=L?i:o;t.useEffect(()=>{if(S(r.time),r.isPlaying){const a=setInterval(()=>{const v=(Date.now()-r.timestamp)/1e3,T=Math.min(r.time+v,r.duration);S(T)},250);return()=>clearInterval(a)}},[r.isPlaying,r.time,r.timestamp,r.duration]),t.useEffect(()=>{const a=p.current;if(!k||L||!a)return;let v=r.time;if(r.isPlaying){const he=(Date.now()-r.timestamp)/1e3;v=r.time+he}const T=a.getCurrentTime();Math.abs(T-v)>1&&(O.current=!0,a.seekTo(v,"seconds"))},[r,k,L]),t.useEffect(()=>{J(g)},[g]);const Y=()=>{var v;if(!k)return;const a=((v=p.current)==null?void 0:v.getCurrentTime())??r.time;s({type:r.isPlaying?"pause":"play",payload:a})},oe=t.useCallback(a=>{z.current===null&&(s({type:"seek",payload:a}),z.current=window.setTimeout(()=>{z.current=null},200))},[s]),ae=()=>{var a;!k||h||(j(!0),n(H),r.isPlaying&&s({type:"pause",payload:((a=p.current)==null?void 0:a.getCurrentTime())??r.time}))},ne=a=>{if(!k||h)return;const v=parseFloat(a.target.value);n(v),oe(v)},le=a=>{if(!k||h)return;z.current&&(window.clearTimeout(z.current),z.current=null);const v=parseFloat(a.currentTarget.value);j(!1),s({type:"seek",payload:v})},ie=a=>{const v=parseFloat(a.target.value);b(v),y(v===0)},ce=()=>{y(a=>!a)},de=()=>{R()},q=t.useCallback(()=>{m(!0),V.current&&window.clearTimeout(V.current),V.current=window.setTimeout(()=>{r.isPlaying&&!g&&m(!1)},3e3)},[r.isPlaying,g]),G=t.useRef(null);t.useEffect(()=>{const a=G.current;return a==null||a.addEventListener("mousemove",q),()=>a==null?void 0:a.removeEventListener("mousemove",q)},[q]);const ue=()=>{},me=a=>{O.current=!1,S(a)},E=!k||!!h||!N;return e.jsx("div",{ref:G,className:I("relative w-full h-full bg-black rounded-xl overflow-hidden group shadow-lg",c),children:r.source?e.jsxs(e.Fragment,{children:[e.jsx(pe,{ref:p,url:r.source,width:"100%",height:"100%",playing:r.isPlaying,volume:C,muted:x,controls:!1,onReady:()=>D(!0),onDuration:a=>s({type:"durationchange",payload:a}),onProgress:ue,onSeek:me,progressInterval:500,onError:(a,v)=>{var W;console.error("Player Error:",a,v);let T="Could not load video. The URL may be invalid, the video is private, or the format is not supported.";const A=typeof v=="number"?v:typeof a=="number"?a:null;if(A!==null)switch(A){case 2:T="The video request contains an invalid parameter. Please check the URL.";break;case 5:T="An HTML5 player error occurred. The video may not be compatible.";break;case 100:case 101:case 150:T="The video owner has disabled playback on other websites. Please choose another video.";break}else a instanceof Error?T=a.message:typeof a=="string"&&a.length>0&&(T=a);F(T),r.isPlaying&&s({type:"pause",payload:(W=p.current)==null?void 0:W.getCurrentTime()})}}),!k&&!h&&e.jsxs("div",{className:"absolute inset-0 bg-black flex flex-col items-center justify-center z-30",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"mt-4 text-white",children:"Loading Player..."})]}),h&&e.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-30 p-4 text-center",children:[e.jsx("p",{className:"text-destructive text-lg font-semibold",children:"Video Error"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:h})]}),e.jsx("div",{className:I("absolute inset-0 w-full h-full z-10",E?"cursor-not-allowed":"cursor-pointer"),onClick:Y,onMouseMove:q}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-20",children:f.map(a=>e.jsx("span",{className:I("absolute text-6xl md:text-8xl animate-fade-in-out"),style:{animationDuration:"5s",top:`${Math.random()*80+10}%`,left:`${Math.random()*80+10}%`},children:a.emoji},a.id))}),e.jsx("div",{className:I("absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/70 to-transparent transition-opacity duration-300 z-20",M||g?"opacity-100":"opacity-0"),children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("input",{type:"range",min:"0",max:r.duration||100,step:"0.1",value:H,onMouseDown:ae,onChange:ne,onMouseUp:le,disabled:E,className:"w-full h-1.5 bg-muted rounded-lg appearance-none cursor-pointer range-sm accent-primary disabled:bg-muted/50 disabled:accent-muted-foreground disabled:cursor-not-allowed"}),e.jsxs("div",{className:"flex items-center justify-between text-white",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:Y,disabled:E,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:r.isPlaying?e.jsx(Me,{className:"w-6 h-6"}):e.jsx(Re,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:ce,disabled:E,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:x?e.jsx(Te,{className:"w-6 h-6"}):e.jsx(Se,{className:"w-6 h-6"})}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.05",value:x?0:C,onChange:ie,disabled:E,className:"w-20 h-1.5 bg-muted rounded-lg appearance-none cursor-pointer range-sm accent-primary disabled:bg-muted/50 disabled:accent-muted-foreground disabled:cursor-not-allowed"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>d("â¤ï¸"),disabled:E,className:"hover:text-red-500 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(be,{className:"w-6 h-6"})}),e.jsx("button",{onClick:()=>d("ðŸ˜‚"),disabled:E,className:"hover:text-yellow-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(ke,{className:"w-6 h-6"})}),e.jsx("button",{onClick:()=>d("ðŸ˜­"),disabled:E,className:"hover:text-blue-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(Ne,{className:"w-6 h-6"})}),e.jsx("button",{onClick:()=>d("ðŸ˜¡"),disabled:E,className:"hover:text-red-600 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(ve,{className:"w-6 h-6"})}),e.jsx("button",{onClick:()=>d("ðŸ”¥"),disabled:E,className:"hover:text-orange-500 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(je,{className:"w-6 h-6"})}),e.jsx("button",{onClick:()=>d("ðŸŽ‰"),disabled:E,className:"hover:text-purple-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(_e,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-sm font-mono text-muted-foreground",children:[re(H)," / ",re(r.duration)]}),g&&e.jsx("button",{onClick:()=>J(a=>!a),disabled:E,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(ye,{className:"w-5 h-5"})}),e.jsx("button",{onClick:de,disabled:E,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(Le,{className:"w-5 h-5"})})]})]})]})})]}):e.jsxs("div",{className:"absolute inset-0 bg-black flex flex-col items-center justify-center z-30 p-4 text-center",children:[e.jsx(Ce,{className:"w-16 h-16 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-foreground",children:"No Video Selected"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:'To start the party, paste a video URL in the field above and click "Set Video".'})]})})},Be=({messages:r,sendMessage:s,currentUser:l,isOverlay:u,onClose:w})=>{const[d,f]=t.useState(""),N=t.useRef(null),R=()=>{var c;(c=N.current)==null||c.scrollIntoView({behavior:"smooth"})};t.useEffect(R,[r]);const g=c=>{c.preventDefault(),d.trim()&&(s(d.trim()),f(""))};return e.jsxs("div",{className:I("flex flex-col h-full min-h-0",u?"backdrop-blur-md rounded-xl shadow-lg":"backdrop-blur-md border border-border/50 rounded-xl shadow-lg"),children:[e.jsxs("div",{className:I("flex-shrink-0 flex items-center justify-between p-4 border-b border-border/50",u?"bg-card/50 rounded-t-xl":""),children:[e.jsx("h3",{className:"text-xl font-bold text-foreground",children:"Live Chat"}),u&&w&&e.jsx(P,{variant:"ghost",size:"icon",onClick:w,className:"w-8 h-8 text-muted-foreground hover:text-foreground hover:bg-accent/20","aria-label":"Close chat",children:e.jsx(fe,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-grow p-4 overflow-y-auto space-y-4",children:[" ",r.map(c=>e.jsx("div",{className:`flex items-start gap-2.5 ${c.isSystem?"justify-center":""} ${c.author===l.name?"justify-end":""}`,children:c.isSystem?e.jsx("span",{className:"text-xs text-center text-muted-foreground italic px-2 py-1 bg-muted/20 rounded-full",children:c.text}):e.jsxs("div",{className:`flex flex-col w-full max-w-[320px] leading-1.5 p-3 border-border/50 rounded-xl shadow-sm ${c.author===l.name?"bg-primary text-primary-foreground rounded-br-none":"bg-muted/20 text-foreground rounded-bl-none"}`,children:[e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:c.author}),e.jsx("span",{className:"text-xs font-normal text-muted-foreground",children:new Date(c.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm font-normal py-2 text-foreground",children:c.text})]})},c.id)),e.jsx("div",{ref:N})]}),e.jsx("form",{onSubmit:g,className:I("flex-shrink-0 p-4 border-t border-border/50",u?"bg-card/50 rounded-b-xl":""),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:d,onChange:c=>f(c.target.value),placeholder:"Say something...",className:"flex-grow px-4 py-2 bg-input/50 border border-border/50 rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary transition"}),e.jsx("button",{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground p-3 rounded-lg transition-colors",children:e.jsx(Ee,{className:"w-5 h-5"})})]})})]})},Ue=(r,s)=>{switch(s.type){case"play":return{...r,isPlaying:!0,time:s.payload};case"pause":return{...r,isPlaying:!1,time:s.payload};case"seek":return{...r,time:s.payload};case"durationchange":return s.payload>0&&r.duration!==s.payload?{...r,duration:s.payload}:r;case"source":return{...r,source:s.payload,time:0,isPlaying:!1,duration:0};default:return r}},qe=(r,s,l)=>{const[u,w]=t.useState({isPlaying:!1,time:0,source:s,duration:0,timestamp:Date.now()}),[d,f]=t.useState([]),[N,R]=t.useState([]),[g,c]=t.useState([]),[p,x]=t.useState(!1),y=t.useRef(null),C=t.useRef(u);t.useEffect(()=>{C.current=u},[u]);const b=t.useCallback(j=>{const i={id:`sys_${Date.now()}`,author:"System",text:j,timestamp:Date.now(),isSystem:!0};f(n=>[...n,i])},[]);t.useEffect(()=>{console.log(`[Realtime Debug] Setting up channel for room: ${r}`),(async()=>{const{data:n,error:o}=await _.from("watch_party_chat_messages").select("*").eq("room_id",r).order("created_at",{ascending:!0});if(o)console.error("Error fetching messages:",o.message),b(`Failed to load chat history: ${o.message}`);else{const D=n.map(h=>({id:h.id,author:h.author_name,text:h.text,timestamp:new Date(h.created_at).getTime()}));f(D)}const{data:S,error:k}=await _.from("watch_party_video_history").select("*").eq("room_id",r).order("created_at",{ascending:!1});if(k)console.error("Error fetching video history:",k.message),b(`Failed to load video history: ${k.message}`);else{const D=S.map(h=>({id:h.id,videoUrl:h.video_url,addedBy:h.user_name,timestamp:new Date(h.created_at).getTime()}));R(h=>[...D,...h])}})();const i=_.channel(`room:${r}_v1`,{config:{presence:{key:l.id}}});return y.current=i,i.on("postgres_changes",{event:"INSERT",schema:"public",table:"watch_party_chat_messages",filter:`room_id=eq.${r}`},n=>{const o=n.new;f(S=>[...S,{id:o.id,author:o.author_name,text:o.text,timestamp:new Date(o.created_at).getTime()}])}),i.on("postgres_changes",{event:"INSERT",schema:"public",table:"watch_party_video_history",filter:`room_id=eq.${r}`},n=>{const o=n.new,S={id:o.id,videoUrl:o.video_url,addedBy:o.user_name,timestamp:new Date(o.created_at).getTime()};R(k=>[S,...k])}),console.log("[Realtime Debug] Attaching 'reactions' postgres_changes listener."),i.on("postgres_changes",{event:"INSERT",schema:"public",table:"reactions",filter:`room_id=eq.${r}`},n=>{console.log("[Reaction Debug] Postgres change for reaction received! Payload:",n.new);const{emoji:o,id:S}=n.new,k=`${o}-${S}`;c(D=>{const h=[...D,{id:k,emoji:o,timestamp:Date.now()}];return console.log("[Reaction Debug] Active reactions updated:",h),h}),setTimeout(()=>{c(D=>{const h=D.filter(F=>F.id!==k);return console.log("[Reaction Debug] Reaction removed. Remaining:",h),h})},5e3)}),console.log("[Realtime Debug] Attaching 'video_state_update' broadcast listener."),i.on("broadcast",{event:"video_state_update"},({payload:n})=>{n.senderId!==l.id&&w(n.newState)}),console.log("[Realtime Debug] Attaching 'REQUEST_VIDEO_STATE' broadcast listener."),i.on("broadcast",{event:"REQUEST_VIDEO_STATE"},({payload:n})=>{n.senderId!==l.id&&C.current&&i.send({type:"broadcast",event:"SYNC_VIDEO_STATE",payload:{videoState:C.current,senderId:l.id}})}),console.log("[Realtime Debug] Attaching 'SYNC_VIDEO_STATE' broadcast listener."),i.on("broadcast",{event:"SYNC_VIDEO_STATE"},({payload:n})=>{n.senderId!==l.id&&w(n.videoState)}),i.on("presence",{event:"join"},({newPresences:n})=>n.forEach(o=>{o.user_name&&b(`${o.user_name} joined.`)})),i.on("presence",{event:"leave"},({leftPresences:n})=>n.forEach(o=>{o.user_name&&b(`${o.user_name} left.`)})),i.subscribe(async(n,o)=>{console.log(`[Realtime Debug] Channel subscription status: ${n}`),n==="SUBSCRIBED"?(x(!0),console.log("[Realtime Debug] Channel ref after subscribe:",y.current),await i.track({user_name:l.name,joined_at:new Date().toISOString()}),i.send({type:"broadcast",event:"REQUEST_VIDEO_STATE",payload:{senderId:l.id}})):(n==="CHANNEL_ERROR"||n==="TIMED_OUT"||n==="CLOSED")&&(x(!1),console.error(`Realtime channel error or closed: ${n}`,o),B.error(`Realtime connection lost: ${(o==null?void 0:o.message)||"Please refresh."}`))}),()=>{console.log(`[Realtime Debug] Cleaning up channel for room: ${r}`),y.current&&(_.removeChannel(y.current),y.current=null,x(!1))}},[r,b,l.name,l.id]);const M=t.useCallback(j=>{w(i=>{const n=Ue(i,j);if(n===i)return i;const o={...n,timestamp:Date.now()};return y.current&&p?y.current.send({type:"broadcast",event:"video_state_update",payload:{newState:o,senderId:l.id}}):console.warn("[Realtime Debug] Not connected to send video state update."),o})},[l.id,p]),m=t.useCallback(async j=>{if(!p){B.error("Cannot send message: Not connected to room.");return}const{error:i}=await _.from("watch_party_chat_messages").insert({room_id:r,user_id:l.id,author_name:l.name,text:j});i&&(console.error("Error sending message:",i.message),b(`Could not send message: ${i.message}`))},[r,l.id,l.name,b,p]),V=t.useCallback(async j=>{if(!p){B.error("Cannot send reaction: Not connected to room.");return}console.log(`[Reaction Debug] Inserting reaction: ${j} for room: ${r}`);const{error:i}=await _.from("reactions").insert({room_id:r,emoji:j});i&&(console.error("Error sending reaction to DB:",i.message),B.error(`Failed to send reaction: ${i.message}`))},[r,p]),L=t.useCallback(async j=>{if(!j.trim())return;const{error:i}=await _.from("watch_party_rooms").update({video_url:j}).eq("id",r);if(i){console.error("Error updating video source:",i),b(`Error: Could not change video. ${i.message}`);return}const{error:n}=await _.from("watch_party_video_history").insert({room_id:r,user_id:l.id,user_name:l.name,video_url:j});n&&console.error("Error adding to video history:",n.message),M({type:"source",payload:j})},[r,l.id,l.name,M,b]);return{videoState:u,sendVideoAction:M,messages:d,sendMessage:m,sendVideoReaction:V,changeVideoSource:L,videoHistory:N,activeReactions:g,isConnectedToRealtime:p}},Fe=({history:r,onSelectVideo:s,className:l})=>{const[u,w]=t.useState(!1);return r.length===0?null:e.jsxs("div",{className:I("bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg",l),children:[e.jsxs(P,{onClick:()=>w(!u),className:"w-full flex justify-between items-center p-4 text-left font-semibold text-foreground bg-transparent hover:bg-accent/20 rounded-xl",variant:"ghost",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($e,{className:"w-6 h-6 text-muted-foreground"}),e.jsxs("span",{children:["Video History (",r.length,")"]})]}),e.jsx("svg",{className:`w-5 h-5 transform transition-transform text-foreground ${u?"rotate-180":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),u&&e.jsx("div",{className:"p-4 border-t border-border/50 max-h-60 overflow-y-auto",children:e.jsx("ul",{className:"space-y-3",children:r.map(d=>e.jsxs("li",{className:"flex items-center justify-between gap-2 p-2 bg-muted/20 rounded-lg border border-border/50 shadow-sm",children:[e.jsxs("div",{className:"flex-grow overflow-hidden",children:[e.jsx("p",{className:"text-sm text-foreground truncate",title:d.videoUrl,children:d.videoUrl}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Added by ",d.addedBy]})]}),e.jsx(P,{onClick:()=>s(d.videoUrl),className:"flex-shrink-0 text-sm bg-primary hover:bg-primary/90 text-primary-foreground font-semibold px-3 py-1 rounded-md transition-colors",size:"sm",children:"Watch"})]},d.id))})})]})},He=({room:r,user:s,onLeaveRoom:l})=>{const u=te(),{videoState:w,sendVideoAction:d,messages:f,sendMessage:N,sendVideoReaction:R,changeVideoSource:g,videoHistory:c,activeReactions:p,isConnectedToRealtime:x}=qe(r.id,r.videoUrl,s),[y,C]=t.useState("Copy Code"),[b,M]=t.useState(""),[m,V]=t.useState(!1),L=t.useRef(null);t.useEffect(()=>{const o=()=>{V(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",o),document.addEventListener("webkitfullscreenchange",o),document.addEventListener("mozfullscreenchange",o),document.addEventListener("MSFullscreenChange",o),()=>{document.removeEventListener("fullscreenchange",o),document.removeEventListener("webkitfullscreenchange",o),document.removeEventListener("mozfullscreenchange",o),document.removeEventListener("MSFullscreenChange",o)}},[]);const j=t.useCallback(()=>{L.current&&(document.fullscreenElement?document.exitFullscreen():L.current.requestFullscreen().catch(o=>{B.error(`Error entering fullscreen: ${o.message}`)}))},[]),i=()=>{navigator.clipboard.writeText(r.room_code),C("Copied!"),B.success("Room code copied to clipboard!"),setTimeout(()=>C("Copy Code"),2e3)},n=o=>{o.preventDefault(),b.trim()&&(g(b.trim()),M(""))};return e.jsx("div",{ref:L,className:$("flex flex-col h-full",{"fullscreen:h-screen fullscreen:flex fullscreen:fixed fullscreen:inset-0 fullscreen:z-50 fullscreen:rounded-none":!0,"bg-background text-foreground":!m,"bg-black":m}),children:e.jsxs("div",{className:$("w-full flex flex-col flex-grow min-h-0 p-4 md:p-6",{"max-w-full mx-0":m}),children:[!m&&e.jsxs("div",{className:"flex items-center justify-between mb-4 flex-shrink-0",children:[" ",e.jsx("div",{className:"flex-shrink-0",children:e.jsx(P,{onClick:()=>u("/dashboard"),variant:"outline",size:"icon",className:"w-10 h-10 text-foreground border-border hover:bg-accent hover:text-accent-foreground rounded-full shadow-md","aria-label":"Back to Dashboard",children:e.jsx(se,{className:"w-5 h-5"})})}),e.jsx("h1",{className:"text-3xl font-bold text-foreground mx-auto",children:"Watch Party"}),e.jsxs("div",{className:"flex items-center gap-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-muted-foreground",children:"Share Code:"}),e.jsx("p",{className:"text-primary font-mono text-lg bg-input/50 px-3 py-1 rounded-md border border-border/50",children:r.room_code}),e.jsxs(P,{onClick:i,variant:"ghost",size:"sm",className:"flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground bg-input/50 hover:bg-accent/50 px-3 py-1 rounded-md transition-colors",children:[e.jsx(De,{className:"h-4 w-4"}),y]})]}),e.jsx(P,{onClick:l,variant:"destructive",size:"icon",className:"w-10 h-10 bg-destructive hover:bg-destructive/90 text-destructive-foreground rounded-full shadow-md",children:e.jsx(we,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:$("flex items-stretch min-h-0 gap-6",{"flex-col md:flex-row":!m,"flex-row h-full":m,"h-[calc(100vh-176px)]":!m}),children:[e.jsxs("div",{className:$("relative w-full flex flex-col gap-4","flex-1 min-h-0",{"md:w-2/3":!m}),children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:$("relative w-full rounded-xl overflow-hidden",{"h-0 pb-[56.25%]":!m,"h-full":m}),children:e.jsx(ze,{videoState:w,sendVideoAction:d,messages:f,sendMessage:N,currentUser:s,sendVideoReaction:R,activeReactions:p,isConnectedToRealtime:x,onToggleFullscreen:j,isTheaterFullscreen:m,className:$({"absolute top-0 left-0 w-full h-full":!m,"w-full h-full":m})})})}),!m&&e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:n,className:$("bg-card/60 backdrop-blur-md border border-border/50 p-4 rounded-xl flex flex-col sm:flex-row items-center gap-3 shadow-lg flex-shrink-0"),children:[e.jsx("label",{htmlFor:"video-url-input",className:"font-semibold text-foreground sr-only",children:"Video URL"}),e.jsxs("div",{className:"relative w-full",children:[e.jsx("div",{className:"absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none",children:e.jsx(Pe,{className:"w-5 h-5 text-muted-foreground"})}),e.jsx("input",{id:"video-url-input",type:"url",value:b,onChange:o=>{M(o.target.value)},placeholder:"Enter YouTube or video URL to start or change the video",className:"w-full bg-input/50 border border-border/50 text-foreground text-sm rounded-lg focus:ring-primary focus:border-primary block ps-10 p-2.5",required:!0})]}),e.jsx(P,{type:"submit",className:"w-full sm:w-auto bg-primary hover:bg-primary/90 text-primary-foreground font-medium rounded-lg text-sm px-5 py-2.5 text-center",children:"Set Video"})]}),e.jsx("div",{className:"pb-6",children:e.jsx(Fe,{history:c,onSelectVideo:g,className:"flex-shrink-0"})})]})]}),!m&&e.jsx("div",{className:$("w-full md:w-1/3 md:max-w-sm flex-shrink-0 flex flex-col","flex-1 min-h-0"),children:e.jsx(Be,{messages:f,sendMessage:N,currentUser:s})})]})]})})},Ae=()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background text-foreground",children:e.jsx("div",{className:"w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"})}),We=r=>({id:r.id,title:`Room ${r.room_code}`,videoUrl:r.video_url,room_code:r.room_code}),rr=()=>{const{session:r,user:s,loading:l}=ge(),u=te(),[w,d]=t.useState(null),[f,N]=t.useState(null),[R,g]=t.useState(!0);t.useEffect(()=>{var x;r&&s?d({id:s.id,name:s.user_metadata.nickname||((x=s.email)==null?void 0:x.split("@")[0])||"Guest",email:s.email}):(d(null),N(null))},[r,s]),t.useEffect(()=>{(async()=>{if(!l&&s){const{data:y,error:C}=await _.from("profiles").select("last_watch_party_room_id").eq("id",s.id).single();C&&C.code!=="PGRST116"&&console.error("Error fetching user profile for watch party:",C.message);const b=y==null?void 0:y.last_watch_party_room_id;if(b){const{data:M,error:m}=await _.from("watch_party_rooms").select("*").eq("id",b).single();m||!M?(console.error("Error loading persisted room from DB:",m==null?void 0:m.message),await _.from("profiles").update({last_watch_party_room_id:null}).eq("id",s.id),N(null)):N(We(M))}}g(!1)})()},[l,s]);const c=t.useCallback(async x=>{if(N(x),s){const{error:y}=await _.from("profiles").update({last_watch_party_room_id:x.id}).eq("id",s.id);y&&console.error("Error saving last room ID to profile:",y.message)}},[s]),p=t.useCallback(async()=>{if(N(null),s){const{error:x}=await _.from("profiles").update({last_watch_party_room_id:null}).eq("id",s.id);x&&console.error("Error clearing last room ID from profile:",x.message)}u("/dashboard")},[u,s]);return l||R?e.jsx(Ae,{}):w?e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx("title",{children:"Watch Party - Anbae"}),e.jsx("meta",{name:"description",content:"Join or create a watch party to watch videos with your partner in real-time."})]}),e.jsx(Z,{className:"pt-0 md:pt-0",solid:!0,children:e.jsx("main",{className:"flex-grow min-h-0 w-full p-0",children:f?e.jsx(He,{room:f,onLeaveRoom:p,user:w}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-5xl font-bold tracking-tighter mb-8 text-foreground text-center",children:"Watch Party"}),e.jsx(Ve,{onJoinRoom:c})]})})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx("title",{children:"Watch Party - Anbae"}),e.jsx("meta",{name:"description",content:"Join or create a watch party to watch videos with your partner in real-time."})]}),e.jsx(Z,{solid:!0,children:e.jsxs("div",{className:"w-full max-w-md bg-card/60 backdrop-blur-md border border-border/50 p-8 rounded-xl shadow-lg text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4 text-foreground",children:"Authentication Error"}),e.jsx("p",{className:"text-muted-foreground",children:"Could not find a valid user session. Please ensure you are logged in."})]})})]})};export{rr as default};
