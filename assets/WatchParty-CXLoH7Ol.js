import{c as F,r as t,j as e,L as fe,B as $,s as _,d as M,a2 as pe,a3 as ge,X as be,a as H,b as se,i as z,n as ye,H as Q,x as we}from"./main-DjNC3G64.js";import{A as te}from"./arrow-left-CCXN5EYU.js";import{L as X}from"./log-in-Cf6AHWQQ.js";import{R as ve}from"./index-D-i1h5OH.js";import{V as je,a as Ne,C as ke}from"./volume-x-yvsOi_IS.js";import{H as _e}from"./heart-Dm1EevTf.js";import{M as Ce}from"./message-square-Bt1ugy7e.js";import{F as Te}from"./film-B1s16scZ.js";import{S as Ee}from"./send-DlU7Tlrp.js";import{u as Se}from"./use-mobile-BsnFEsyn.js";import{L as Re}from"./log-out-DczWjQVn.js";import"./index-Chjiymov.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=F("Angry",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M16 16s-1.5-2-4-2-4 2-4 2",key:"epbg0q"}],["path",{d:"M7.5 8 10 9",key:"olxxln"}],["path",{d:"m14 9 2.5-1",key:"1j6cij"}],["path",{d:"M9 10h.01",key:"qbtxuw"}],["path",{d:"M15 10h.01",key:"1qmjsl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=F("Flame",[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=F("Frown",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M16 16s-1.5-2-4-2-4 2-4 2",key:"epbg0q"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=F("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=F("Laugh",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M18 13a6 6 0 0 1-6 5 6 6 0 0 1-6-5h12Z",key:"b2q4dd"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=F("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=F("Maximize",[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=F("PartyPopper",[["path",{d:"M5.8 11.3 2 22l10.7-3.79",key:"gwxi1d"}],["path",{d:"M4 3h.01",key:"1vcuye"}],["path",{d:"M22 8h.01",key:"1mrtc2"}],["path",{d:"M15 2h.01",key:"1cjtqr"}],["path",{d:"M22 20h.01",key:"1mrys2"}],["path",{d:"m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10",key:"hbicv8"}],["path",{d:"m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11c-.11.7-.72 1.22-1.43 1.22H17",key:"1i94pl"}],["path",{d:"m11 2 .33.82c.34.86-.2 1.82-1.11 1.98C9.52 4.9 9 5.52 9 6.23V7",key:"1cofks"}],["path",{d:"M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z",key:"4kbmks"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=F("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),K=s=>({id:s.id,title:`Room ${s.room_code}`,videoUrl:s.video_url,room_code:s.room_code}),Ue=()=>{const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let r="";for(let n=0;n<6;n++)r+=s.charAt(Math.floor(Math.random()*s.length));return r},Ve=({onJoinRoom:s})=>{const[r,n]=t.useState(""),[x,f]=t.useState(null),[c,h]=t.useState(null),v=async()=>{f("create"),h(null);let g="",j=!1,l=0;for(;!j&&l<10;){g=Ue();const{data:N,error:u}=await _.from("watch_party_rooms").select("id").eq("room_code",g).single();if(u&&u.code==="PGRST116")j=!0;else if(u){console.error("Error checking for room code uniqueness:",u),h("Could not verify room code. Please try again."),f(null);return}l++}if(!j){h("Failed to generate a unique room code. Please try again."),f(null);return}const{data:p,error:b}=await _.from("watch_party_rooms").insert({room_code:g,video_url:"",playback_status:"unstarted"}).select().single();b?(console.error("Error creating room:",b),h("Could not create a room. Please try again.")):p&&s(K(p)),f(null)},T=async g=>{if(g.preventDefault(),!r.trim()){h("Please enter a room code.");return}f("join"),h(null);const j=r.trim().toUpperCase(),{data:l,error:p}=await _.from("watch_party_rooms").select("*").eq("room_code",j).single();p||!l?h(`Room with code "${j}" not found.`):s(K(l)),f(null)};return e.jsxs("div",{className:"max-w-md sm:max-w-4xl mx-auto px-4",children:[" ",e.jsxs("div",{className:"flex justify-between items-center mb-6 sm:mb-8",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(fe,{to:"/dashboard",className:"flex items-center justify-center bg-card/60 backdrop-blur-md border border-border/50 hover:bg-accent/60 text-foreground p-2.5 sm:p-3 rounded-full transition-colors shadow-md","aria-label":"Back to Dashboard",children:e.jsx(te,{className:"h-4 w-4 sm:h-5 sm:w-5"})})}),e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold tracking-tighter text-foreground mx-auto",children:"Theater"}),e.jsx("div",{className:"flex-shrink-0 w-9 sm:w-10"})," "]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-8",children:[" ",e.jsxs("div",{className:"bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg p-6 sm:p-8 flex flex-col items-center text-center transition-all duration-300 hover:shadow-xl hover:scale-[1.02]",children:[e.jsx("div",{className:"bg-primary/20 p-3 sm:p-4 rounded-full mb-3 sm:mb-4",children:e.jsx(Z,{className:"h-8 w-8 sm:h-10 sm:w-10 text-primary"})}),e.jsx("h2",{className:"text-xl sm:text-2xl text-foreground font-semibold mb-2",children:"Start a New Theater"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground mb-5 sm:mb-6",children:"Create a private room and get a shareable code. You can add a video once you're inside."}),e.jsxs("div",{className:"w-full flex flex-col gap-3 sm:gap-4",children:[c&&e.jsx("p",{className:"text-destructive text-xs sm:text-sm mt-2",children:c}),e.jsxs($,{onClick:v,disabled:!!x,className:"w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-primary-foreground font-bold px-5 py-2.5 sm:px-6 sm:py-3 rounded-lg transition-all transform hover:scale-105 disabled:bg-primary/50 disabled:cursor-not-allowed text-sm sm:text-base",children:[e.jsx(Z,{className:"h-5 w-5 sm:h-6 sm:w-6"}),x==="create"?"Creating...":"Create Private Room"]})]})]}),e.jsxs("div",{className:"bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg p-6 sm:p-8 flex flex-col items-center text-center transition-all duration-300 hover:shadow-xl hover:scale-[1.02]",children:[e.jsx("div",{className:"bg-secondary/20 p-3 sm:p-4 rounded-full mb-3 sm:mb-4",children:e.jsx(X,{className:"h-8 w-8 sm:h-10 sm:w-10 text-secondary"})}),e.jsx("h2",{className:"text-xl sm:text-2xl text-foreground font-semibold mb-2",children:"Join an Existing Theater"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground mb-5 sm:mb-6",children:"Enter the 6-character code your friend gave you."}),e.jsxs("form",{onSubmit:T,className:"w-full flex flex-col gap-3 sm:gap-4",children:[e.jsx("input",{type:"text",value:r,onChange:g=>{n(g.target.value.toUpperCase()),c&&h(null)},placeholder:"ABC-123",maxLength:7,className:"w-full text-center text-lg sm:text-xl tracking-widest font-mono px-3 py-2.5 sm:px-4 sm:py-3 bg-input/50 border border-border/50 rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary transition",required:!0,disabled:!!x}),c&&e.jsx("p",{className:"text-destructive text-xs sm:text-sm",children:c}),e.jsxs($,{type:"submit",disabled:!!x,className:"w-full flex items-center justify-center gap-2 bg-secondary hover:bg-secondary/90 text-secondary-foreground font-bold px-5 py-2.5 sm:px-6 sm:py-3 rounded-lg transition-all transform hover:scale-105 disabled:bg-secondary/50 disabled:cursor-not-allowed text-sm sm:text-base",children:[e.jsx(X,{className:"h-5 w-5 sm:h-6 sm:w-6"}),x==="join"?"Joining...":"Join With Code"]})]})]})]})]})},ee=s=>{if(isNaN(s)||s<0)return"00:00";const r=Math.floor(s/60).toString().padStart(2,"0"),n=Math.floor(s%60).toString().padStart(2,"0");return`${r}:${n}`},ze=({videoState:s,sendVideoAction:r,messages:n,sendMessage:x,currentUser:f,sendVideoReaction:c,activeReactions:h,isConnectedToRealtime:v,onToggleFullscreen:T,isTheaterFullscreen:g,className:j,isChatOpen:l,onToggleChat:p,isMobile:b})=>{const N=t.useRef(null),[u,S]=t.useState(!0),[C,U]=t.useState(.8),[L,w]=t.useState(!0),i=t.useRef(null),[a,d]=t.useState(!1),[P,R]=t.useState(0),[m,k]=t.useState(s.time),[D,re]=t.useState(!1),[I,ae]=t.useState(null),W=t.useRef(!1),V=t.useRef(null),O=a?P:m;t.useEffect(()=>{if(k(s.time),s.isPlaying){const o=setInterval(()=>{const y=(Date.now()-s.timestamp)/1e3,q=Math.min(s.time+y,s.duration);k(q)},250);return()=>clearInterval(o)}},[s.isPlaying,s.time,s.timestamp,s.duration]),t.useEffect(()=>{const o=N.current;if(!D||a||!o)return;let y=s.time;if(s.isPlaying){const he=(Date.now()-s.timestamp)/1e3;y=s.time+he}const q=o.getCurrentTime();Math.abs(q-y)>1&&(W.current=!0,o.seekTo(y,"seconds"))},[s,D,a]);const Y=()=>{var y;if(!D)return;const o=((y=N.current)==null?void 0:y.getCurrentTime())??s.time;r({type:s.isPlaying?"pause":"play",payload:o})},oe=t.useCallback(o=>{V.current===null&&(r({type:"seek",payload:o}),V.current=window.setTimeout(()=>{V.current=null},200))},[r]),ne=()=>{var o;!D||I||(d(!0),R(O),s.isPlaying&&r({type:"pause",payload:((o=N.current)==null?void 0:o.getCurrentTime())??s.time}))},le=o=>{if(!D||I)return;const y=parseFloat(o.target.value);R(y),oe(y)},ie=o=>{if(!D||I)return;V.current&&(window.clearTimeout(V.current),V.current=null);const y=parseFloat(o.currentTarget.value);d(!1),r({type:"seek",payload:y})},de=o=>{const y=parseFloat(o.target.value);U(y),S(y===0)},ce=()=>{S(o=>!o)},me=()=>{T()},A=t.useCallback(()=>{w(!0),i.current&&window.clearTimeout(i.current),i.current=window.setTimeout(()=>{s.isPlaying&&!g&&w(!1)},3e3)},[s.isPlaying,g]),G=t.useRef(null);t.useEffect(()=>{const o=G.current;return o==null||o.addEventListener("mousemove",A),()=>o==null?void 0:o.removeEventListener("mousemove",A)},[A]);const ue=()=>{},xe=o=>{W.current=!1,k(o)},E=!D||!!I||!v;return e.jsx("div",{ref:G,className:M("relative w-full bg-black rounded-xl overflow-hidden group shadow-lg",j),children:s.source?e.jsxs(e.Fragment,{children:[e.jsx(ve,{ref:N,url:s.source,width:"100%",height:"100%",playing:s.isPlaying,volume:C,muted:u,controls:!1,onReady:()=>re(!0),onDuration:o=>r({type:"durationchange",payload:o}),onProgress:ue,onSeek:xe,progressInterval:500,onError:(o,y)=>{var J;let q="Could not load video. The URL may be invalid, the video is private, or the format is not supported.";const B=typeof y=="number"?y:typeof o=="number"?o:null;if(B!==null)switch(B){case 2:q="The video request contains an invalid parameter. Please check the URL.";break;case 5:q="An HTML5 player error occurred. The video may not be compatible.";break;case 100:case 101:case 150:q="The video owner has disabled playback on other websites. Please choose another video.";break}else o instanceof Error?q=o.message:typeof o=="string"&&o.length>0&&(q=o);ae(q),s.isPlaying&&r({type:"pause",payload:(J=N.current)==null?void 0:J.getCurrentTime()})}}),!D&&!I&&e.jsxs("div",{className:"absolute inset-0 bg-black flex flex-col items-center justify-center z-30",children:[e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"mt-3 sm:mt-4 text-white text-sm sm:text-base",children:"Loading Player..."})]}),I&&e.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-30 p-4 text-center",children:[e.jsx("p",{className:"text-destructive text-base sm:text-lg font-semibold",children:"Video Error"}),e.jsx("p",{className:"text-muted-foreground mt-1 sm:mt-2 text-sm sm:text-base",children:I})]}),e.jsx("div",{className:M("absolute inset-0 w-full h-full z-10",E?"cursor-not-allowed":"cursor-pointer"),onClick:Y,onMouseMove:A}),e.jsx("button",{onClick:me,disabled:E,className:"absolute top-3 right-3 z-30 p-2 rounded-full bg-black/50 text-white hover:bg-black/70 transition-colors disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Toggle fullscreen",children:e.jsx(Fe,{className:"w-4 h-4 sm:w-5 h-5"})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-20",children:h.map(o=>e.jsx("span",{className:M("absolute text-5xl sm:text-6xl md:text-8xl animate-fade-in-out"),style:{animationDuration:"5s",top:`${Math.random()*80+10}%`,left:`${Math.random()*80+10}%`},children:o.emoji},o.id))}),e.jsx("div",{className:M("absolute bottom-0 left-0 right-0 p-3 sm:p-4 bg-gradient-to-t from-black/70 to-transparent transition-opacity duration-300 z-20",L||g?"opacity-100":"opacity-0"),children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("input",{type:"range",min:"0",max:s.duration||100,step:"0.1",value:O,onMouseDown:ne,onChange:le,onMouseUp:ie,disabled:E,className:"w-full h-1 bg-muted rounded-lg appearance-none cursor-pointer range-sm accent-primary disabled:bg-muted/50 disabled:accent-muted-foreground disabled:cursor-not-allowed"}),e.jsxs("div",{className:"flex items-center justify-between text-white",children:[e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsx("button",{onClick:Y,disabled:E,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:s.isPlaying?e.jsx(pe,{className:"w-4 h-4 sm:w-5 sm:h-5"}):e.jsx(ge,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("button",{onClick:ce,disabled:E,className:"hover:text-primary transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:u?e.jsx(je,{className:"w-4 h-4 sm:w-5 sm:h-5"}):e.jsx(Ne,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.05",value:u?0:C,onChange:de,disabled:E,className:"w-16 sm:w-20 h-1 bg-muted rounded-lg appearance-none cursor-pointer range-sm accent-primary disabled:bg-muted/50 disabled:accent-muted-foreground disabled:cursor-not-allowed"})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("button",{onClick:()=>c("❤️"),disabled:E,className:"hover:text-red-500 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(_e,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:()=>c("😂"),disabled:E,className:"hover:text-yellow-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(qe,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:()=>c("😭"),disabled:E,className:"hover:text-blue-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(Le,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:()=>c("😡"),disabled:E,className:"hover:text-red-600 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(Me,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:()=>c("🔥"),disabled:E,className:"hover:text-orange-500 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(Pe,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:()=>c("🎉"),disabled:E,className:"hover:text-purple-400 transition-colors disabled:text-muted-foreground disabled:cursor-not-allowed",children:e.jsx(Ie,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]}),e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsxs("span",{className:"text-xs sm:text-sm font-mono text-muted-foreground",children:[ee(O)," / ",ee(s.duration)]}),!b&&e.jsx($,{onClick:p,variant:"ghost",size:"icon",className:"w-7 h-7 sm:w-8 sm:h-8 text-white hover:bg-white/20","aria-label":l?"Close Chat":"Open Chat",disabled:E,children:e.jsx(Ce,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]})]})]})})]}):e.jsxs("div",{className:"absolute inset-0 bg-black flex flex-col items-center justify-center z-30 p-4 text-center",children:[e.jsx(Te,{className:"w-12 h-12 sm:w-16 sm:h-16 text-muted-foreground mb-3 sm:mb-4"}),e.jsx("h3",{className:"text-base sm:text-xl font-bold text-foreground",children:"No Video Selected"}),e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground mt-1 sm:mt-2",children:'To start the party, paste a video URL in the field above and click "Set Video".'})]})})},He=({messages:s,sendMessage:r,currentUser:n,isTheaterFullscreen:x,isMobile:f,onClose:c})=>{const[h,v]=t.useState(""),T=t.useRef(null),g=()=>{var l;(l=T.current)==null||l.scrollIntoView({behavior:"smooth"})};t.useEffect(g,[s]);const j=l=>{l.preventDefault(),h.trim()&&(r(h.trim()),v(""))};return e.jsxs("div",{className:M("flex flex-col h-full min-h-0",x&&f?"bg-black text-white rounded-none shadow-none border-none":"backdrop-blur-md border border-border/50 rounded-xl shadow-lg"),children:[e.jsxs("div",{className:M("flex-shrink-0 flex items-center justify-between p-3 sm:p-4 border-b border-border/50",x&&f?"bg-black/50 border-white/20":"bg-card/50 rounded-t-xl"),children:[e.jsx("h3",{className:"text-lg sm:text-xl font-bold text-foreground",children:"Live Chat"}),!f&&c&&e.jsx("button",{onClick:c,className:"p-1 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 transition-colors","aria-label":"Close chat",children:e.jsx(be,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-grow p-3 sm:p-4 overflow-y-auto space-y-3 sm:space-y-4",children:[s.map(l=>e.jsx("div",{className:`flex items-start gap-2 ${l.isSystem?"justify-center":""} ${l.author===n.name?"justify-end":""}`,children:l.isSystem?e.jsx("span",{className:"text-xs text-center text-muted-foreground italic px-2 py-1 bg-muted/20 rounded-full",children:l.text}):e.jsxs("div",{className:M("flex flex-col w-full max-w-[280px] sm:max-w-[320px] leading-1.5 p-2.5 sm:p-3 border-border/50 rounded-xl shadow-sm",l.author===n.name?"bg-primary text-primary-foreground rounded-br-none":"bg-muted/20 text-foreground rounded-bl-none"),children:[e.jsxs("div",{className:"flex items-center space-x-1.5 sm:space-x-2 rtl:space-x-reverse",children:[e.jsx("span",{className:M("text-xs sm:text-sm font-semibold",l.author===n.name?"text-primary-foreground":"text-foreground"),children:l.author}),e.jsx("span",{className:M("text-xs font-normal",l.author===n.name?"text-primary-foreground/80":"text-muted-foreground"),children:new Date(l.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:M("text-sm font-normal py-1.5 sm:py-2",l.author===n.name?"text-primary-foreground":"text-foreground"),children:l.text})]})},l.id)),e.jsx("div",{ref:T})]}),e.jsx("form",{onSubmit:j,className:M("flex-shrink-0 p-3 sm:p-4 border-t border-border/50",x&&f?"bg-black/50 border-white/20":"bg-card/50 rounded-b-xl"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:h,onChange:l=>v(l.target.value),placeholder:"Say something...",className:"flex-grow px-3 py-2 bg-input/50 border border-border/50 rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary transition text-sm sm:text-base"}),e.jsx("button",{type:"submit",className:"bg-primary hover:bg-primary/90 text-primary-foreground p-2.5 sm:p-3 rounded-lg transition-colors",children:e.jsx(Ee,{className:"w-4 h-4 sm:w-5 h-5"})})]})})]})},Ae=(s,r)=>{switch(r.type){case"play":return{...s,isPlaying:!0,time:r.payload};case"pause":return{...s,isPlaying:!1,time:r.payload};case"seek":return{...s,time:r.payload};case"durationchange":return r.payload>0&&s.duration!==r.payload?{...s,duration:r.payload}:s;case"source":return{...s,source:r.payload,time:0,isPlaying:!1,duration:0};default:return s}},Oe=(s,r,n)=>{const[x,f]=t.useState({isPlaying:!1,time:0,source:r,duration:0,timestamp:Date.now()}),[c,h]=t.useState([]),[v,T]=t.useState([]),[g,j]=t.useState([]),[l,p]=t.useState(!1),b=t.useRef(null),N=t.useRef(x);t.useEffect(()=>{N.current=x},[x]);const u=t.useCallback(w=>{const i={id:`sys_${Date.now()}`,author:"System",text:w,timestamp:Date.now(),isSystem:!0};h(a=>[...a,i])},[]);t.useEffect(()=>{(async()=>{const{data:a,error:d}=await _.from("watch_party_chat_messages").select("*").eq("room_id",s).order("created_at",{ascending:!0});if(d)u(`Failed to load chat history: ${d.message}`);else{const m=a.map(k=>({id:k.id,author:k.author_name,text:k.text,timestamp:new Date(k.created_at).getTime()}));h(m)}const{data:P,error:R}=await _.from("watch_party_video_history").select("*").eq("room_id",s).order("created_at",{ascending:!1});if(R)u(`Failed to load video history: ${R.message}`);else{const m=P.map(k=>({id:k.id,videoUrl:k.video_url,addedBy:k.user_name,timestamp:new Date(k.created_at).getTime()}));T(k=>[...m,...k])}})();const i=_.channel(`room:${s}_v1`,{config:{presence:{key:n.id}}});return b.current=i,i.on("postgres_changes",{event:"INSERT",schema:"public",table:"watch_party_chat_messages",filter:`room_id=eq.${s}`},a=>{const d=a.new;h(P=>[...P,{id:d.id,author:d.author_name,text:d.text,timestamp:new Date(d.created_at).getTime()}])}),i.on("postgres_changes",{event:"INSERT",schema:"public",table:"watch_party_video_history",filter:`room_id=eq.${s}`},a=>{const d=a.new,P={id:d.id,videoUrl:d.video_url,addedBy:d.user_name,timestamp:new Date(d.created_at).getTime()};T(R=>[P,...R])}),i.on("postgres_changes",{event:"INSERT",schema:"public",table:"reactions",filter:`room_id=eq.${s}`},a=>{const{emoji:d,id:P}=a.new,R=`${d}-${P}`;j(m=>[...m,{id:R,emoji:d,timestamp:Date.now()}]),setTimeout(()=>{j(m=>m.filter(D=>D.id!==R))},5e3)}),i.on("broadcast",{event:"video_state_update"},({payload:a})=>{a.senderId!==n.id&&f(a.newState)}),i.on("broadcast",{event:"REQUEST_VIDEO_STATE"},({payload:a})=>{a.senderId!==n.id&&N.current&&i.send({type:"broadcast",event:"SYNC_VIDEO_STATE",payload:{videoState:N.current,senderId:n.id}})}),i.on("broadcast",{event:"SYNC_VIDEO_STATE"},({payload:a})=>{a.senderId!==n.id&&f(a.videoState)}),i.on("presence",{event:"join"},({newPresences:a})=>a.forEach(d=>{d.user_name&&u(`${d.user_name} joined.`)})),i.on("presence",{event:"leave"},({leftPresences:a})=>a.forEach(d=>{d.user_name&&u(`${d.user_name} left.`)})),i.subscribe(async(a,d)=>{a==="SUBSCRIBED"?(p(!0),await i.track({user_name:n.name,joined_at:new Date().toISOString()}),i.send({type:"broadcast",event:"REQUEST_VIDEO_STATE",payload:{senderId:n.id}})):(a==="CHANNEL_ERROR"||a==="TIMED_OUT"||a==="CLOSED")&&(p(!1),H.error(`Realtime connection lost: ${(d==null?void 0:d.message)||"Please refresh."}`))}),()=>{b.current&&(_.removeChannel(b.current),b.current=null,p(!1))}},[s,u,n.name,n.id]);const S=t.useCallback(w=>{f(i=>{const a=Ae(i,w);if(a===i)return i;const d={...a,timestamp:Date.now()};return b.current&&l&&b.current.send({type:"broadcast",event:"video_state_update",payload:{newState:d,senderId:n.id}}),d})},[n.id,l]),C=t.useCallback(async w=>{if(!l){H.error("Cannot send message: Not connected to room.");return}const{error:i}=await _.from("watch_party_chat_messages").insert({room_id:s,user_id:n.id,author_name:n.name,text:w});i&&u(`Could not send message: ${i.message}`)},[s,n.id,n.name,u,l]),U=t.useCallback(async w=>{if(!l){H.error("Cannot send reaction: Not connected to room.");return}const{error:i}=await _.from("reactions").insert({room_id:s,emoji:w});i&&H.error(`Failed to send reaction: ${i.message}`)},[s,l]),L=t.useCallback(async w=>{if(!w.trim())return;const{error:i}=await _.from("watch_party_rooms").update({video_url:w}).eq("id",s);if(i){u(`Error: Could not change video. ${i.message}`);return}const{error:a}=await _.from("watch_party_video_history").insert({room_id:s,user_id:n.id,user_name:n.name,video_url:w});S({type:"source",payload:w})},[s,n.id,n.name,S,u]);return{videoState:x,sendVideoAction:S,messages:c,sendMessage:C,sendVideoReaction:U,changeVideoSource:L,videoHistory:v,activeReactions:g,isConnectedToRealtime:l}},Be=({history:s,onSelectVideo:r,className:n})=>{const[x,f]=t.useState(!1);return s.length===0?null:e.jsxs("div",{className:M("bg-card/60 backdrop-blur-md border border-border/50 rounded-xl shadow-lg",n),children:[e.jsxs($,{onClick:()=>f(!x),className:"w-full flex justify-between items-center p-3 sm:p-4 text-left font-semibold text-foreground bg-transparent hover:bg-accent/20 rounded-xl h-auto",variant:"ghost",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[" ",e.jsx(De,{className:"w-5 h-5 sm:w-6 h-6 text-muted-foreground"})," ",e.jsxs("span",{className:"text-sm sm:text-base",children:["Video History (",s.length,")"]})," "]}),e.jsx("svg",{className:`w-4 h-4 sm:w-5 h-5 transform transition-transform text-foreground ${x?"rotate-180":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),x&&e.jsxs("div",{className:"p-3 sm:p-4 border-t border-border/50 max-h-52 sm:max-h-60 overflow-y-auto",children:[" ",e.jsxs("ul",{className:"space-y-2 sm:space-y-3",children:[" ",s.map(c=>e.jsxs("li",{className:"flex items-center justify-between gap-2 p-2 bg-muted/20 rounded-lg border border-border/50 shadow-sm",children:[e.jsxs("div",{className:"flex-grow overflow-hidden",children:[e.jsx("p",{className:"text-xs sm:text-sm text-foreground truncate",title:c.videoUrl,children:c.videoUrl})," ",e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Added by ",c.addedBy]})]}),e.jsx($,{onClick:()=>r(c.videoUrl),className:"flex-shrink-0 text-xs sm:text-sm bg-primary hover:bg-primary/90 text-primary-foreground font-semibold px-2.5 py-1 sm:px-3 sm:py-1.5 rounded-md transition-colors h-auto",size:"sm",children:"Watch"})]},c.id))]})]})]})},Je=({room:s,user:r,onLeaveRoom:n})=>{const x=se(),{videoState:f,sendVideoAction:c,messages:h,sendMessage:v,sendVideoReaction:T,changeVideoSource:g,videoHistory:j,activeReactions:l,isConnectedToRealtime:p}=Oe(s.id,s.videoUrl,r),[b,N]=t.useState("Copy Code"),[u,S]=t.useState(""),[C,U]=t.useState(!0),[L,w]=t.useState(!1),i=t.useRef(null),a=Se();t.useEffect(()=>{const m=()=>{w(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",m),document.addEventListener("webkitfullscreenchange",m),document.addEventListener("mozfullscreenchange",m),document.addEventListener("MSFullscreenChange",m),()=>{document.removeEventListener("fullscreenchange",m),document.removeEventListener("webkitfullscreenchange",m),document.removeEventListener("mozfullscreenchange",m),document.removeEventListener("MSFullscreenChange",m)}},[]);const d=t.useCallback(()=>{i.current&&(document.fullscreenElement?document.exitFullscreen():i.current.requestFullscreen().catch(m=>{H.error(`Error entering fullscreen: ${m.message}`)}))},[]),P=()=>{navigator.clipboard.writeText(s.room_code),N("Copied!"),H.success("Room code copied to clipboard!"),setTimeout(()=>N("Copy Code"),2e3)},R=m=>{m.preventDefault(),u.trim()&&(g(u.trim()),S(""))};return e.jsx("div",{ref:i,className:z("flex flex-col w-full",L?"fixed inset-0 z-50 rounded-none bg-black":"h-screen bg-background text-foreground"),children:e.jsxs("div",{className:z("w-full flex flex-col flex-grow min-h-0 p-3 sm:p-4 md:p-6",{"max-w-full mx-0":L}),children:[!L&&e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 sm:mb-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between w-full sm:w-auto mb-3 sm:mb-0",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx($,{onClick:()=>x("/dashboard"),variant:"outline",size:"icon",className:"w-9 h-9 sm:w-10 sm:h-10 text-foreground border-border hover:bg-accent hover:text-accent-foreground rounded-full shadow-md","aria-label":"Back to Dashboard",children:e.jsx(te,{className:"w-4 h-4 sm:w-5 sm:h-5"})})}),e.jsx("h1",{className:"text-xl sm:text-3xl font-bold tracking-tighter text-foreground ml-auto sm:ml-4",children:"Theater"})]}),e.jsxs("div",{className:"flex items-center justify-between w-full sm:w-auto gap-2 sm:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground hidden sm:inline",children:"Share Code:"}),e.jsx("p",{className:"text-sm sm:text-lg font-mono text-primary bg-input/50 px-2 py-0.5 sm:px-3 sm:py-1 rounded-md border border-border/50",children:s.room_code}),e.jsxs($,{onClick:P,variant:"ghost",size:"sm",className:"flex items-center gap-1 sm:gap-1.5 text-xs sm:text-sm text-muted-foreground hover:text-foreground bg-input/50 hover:bg-accent/50 px-2 py-0.5 sm:px-3 sm:py-1 rounded-md transition-colors h-auto",children:[e.jsx(ke,{className:"h-3 w-3 sm:h-4 sm:w-4"}),b]})]}),e.jsx($,{onClick:n,variant:"destructive",size:"icon",className:"w-9 h-9 sm:w-10 sm:h-10 bg-destructive hover:bg-destructive/90 text-destructive-foreground rounded-full shadow-md",children:e.jsx(Re,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]})]}),e.jsxs("div",{className:z("flex flex-grow min-h-0 gap-6 sm:gap-8",{"flex-col":a,"sm:flex-row":!a}),children:[e.jsx("div",{className:z("relative w-full rounded-xl overflow-hidden transition-all duration-300 ease-in-out",{"flex-1 min-h-0":a,"sm:flex-[3] sm:h-full":!a&&C,"sm:flex-grow sm:h-full":!a&&!C}),children:e.jsx(ze,{videoState:f,sendVideoAction:c,messages:h,sendMessage:v,currentUser:r,sendVideoReaction:T,activeReactions:l,isConnectedToRealtime:p,onToggleFullscreen:d,isTheaterFullscreen:L,className:"w-full h-full",isChatOpen:C,onToggleChat:()=>U(m=>!m),isMobile:a})}),(C||a)&&e.jsx("div",{className:z("w-full flex flex-col transition-all duration-300 ease-in-out",{"flex-1 min-h-0":a,"sm:flex-[1] sm:h-full sm:min-w-[320px]":!a}),children:e.jsx(He,{messages:h,sendMessage:v,currentUser:r,isTheaterFullscreen:L,isMobile:a,onClose:a?void 0:()=>U(!1)})})]}),!L&&e.jsxs("div",{className:"flex flex-col gap-4 sm:gap-6 mt-6 sm:mt-8 flex-shrink-0",children:[e.jsxs("form",{onSubmit:R,className:z("bg-card/60 backdrop-blur-md border border-border/50 p-3 sm:p-4 rounded-xl flex flex-col sm:flex-row items-center gap-2 sm:gap-3 shadow-lg"),children:[e.jsx("label",{htmlFor:"video-url-input",className:"font-semibold text-foreground sr-only",children:"Video URL"}),e.jsxs("div",{className:"relative w-full",children:[e.jsx("div",{className:"absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none",children:e.jsx($e,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("input",{id:"video-url-input",type:"url",value:u,onChange:m=>{S(m.target.value)},placeholder:"Enter YouTube or video URL to start or change the video",className:"w-full bg-input/50 border border-border/50 text-foreground text-xs sm:text-sm rounded-lg focus:ring-primary focus:border-primary block ps-9 p-2 sm:ps-10 sm:p-2.5",required:!0})]}),e.jsx($,{type:"submit",className:"w-full sm:w-auto bg-primary hover:bg-primary/90 text-primary-foreground font-medium rounded-lg text-xs sm:text-sm px-4 py-2 sm:px-5 sm:py-2.5 text-center h-auto",children:"Set Video"})]}),e.jsx("div",{children:e.jsx(Be,{history:j,onSelectVideo:g,className:"flex-shrink-0"})})]})]})})},We=()=>e.jsx("div",{className:"min-h-screen flex flex-col items-center justify-center bg-background text-foreground",children:e.jsx(we,{})}),Ye=s=>({id:s.id,title:`Room ${s.room_code}`,videoUrl:s.video_url,room_code:s.room_code}),ls=()=>{const{session:s,user:r,loading:n}=ye(),x=se(),[f,c]=t.useState(null),[h,v]=t.useState(null),[T,g]=t.useState(!0);t.useEffect(()=>{var p;s&&r?c({id:r.id,name:r.user_metadata.nickname||((p=r.email)==null?void 0:p.split("@")[0])||"Guest",email:r.email}):(c(null),v(null))},[s,r]),t.useEffect(()=>{(async()=>{if(!n&&r){const{data:b,error:N}=await _.from("profiles").select("last_watch_party_room_id").eq("id",r.id).single();N&&N.code!=="PGRST116"&&console.error("Error fetching user profile for watch party:",N.message);const u=b==null?void 0:b.last_watch_party_room_id;if(u){const{data:S,error:C}=await _.from("watch_party_rooms").select("*").eq("id",u).single();C||!S?(console.error("Error loading persisted room from DB:",C==null?void 0:C.message),await _.from("profiles").update({last_watch_party_room_id:null}).eq("id",r.id),v(null)):v(Ye(S))}}g(!1)})()},[n,r]);const j=t.useCallback(async p=>{if(v(p),r){const{error:b}=await _.from("profiles").update({last_watch_party_room_id:p.id}).eq("id",r.id);b&&console.error("Error saving last room ID to profile:",b.message)}},[r]),l=t.useCallback(async()=>{if(v(null),r){const{error:p}=await _.from("profiles").update({last_watch_party_room_id:null}).eq("id",r.id);p&&console.error("Error clearing last room ID from profile:",p.message)}x("/dashboard")},[x,r]);return n||T?e.jsx(We,{}):f?e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx("title",{children:"Theater - Anbae"}),e.jsx("meta",{name:"description",content:"Join or create a theater to watch videos with your partner in real-time."})]}),e.jsx("div",{className:"min-h-screen w-full bg-background text-foreground flex flex-col",children:e.jsx("main",{className:"flex-grow min-h-0 w-full p-0",children:h?e.jsx(Je,{room:h,onLeaveRoom:l,user:f}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-4xl sm:text-5xl font-bold tracking-tighter mb-6 sm:mb-8 text-foreground text-center",children:"Theater"}),e.jsx(Ve,{onJoinRoom:j})]})})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx("title",{children:"Theater - Anbae"}),e.jsx("meta",{name:"description",content:"Join or create a theater to watch videos with your partner in real-time."})]}),e.jsx("div",{className:"min-h-screen w-full bg-background text-foreground flex flex-col items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-sm sm:max-w-md bg-card/60 backdrop-blur-md border border-border/50 p-6 sm:p-8 rounded-xl shadow-lg text-center",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-foreground",children:"Authentication Error"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:"Could not find a valid user session. Please ensure you are logged in."})]})})]})};export{ls as default};
